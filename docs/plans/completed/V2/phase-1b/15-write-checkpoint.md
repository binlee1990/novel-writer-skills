# Task 15: `/write` æ–­ç‚¹ç»­å†™æœºåˆ¶

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** åœ¨ `/write` å‘½ä»¤ä¸­å¢åŠ æ–­ç‚¹ç»­å†™æœºåˆ¶ï¼Œæ”¯æŒå†™ä½œä¸­æ–­åä»æ–­ç‚¹æ¢å¤ï¼Œé¿å…é‡å¤åŠ è½½å’Œå†…å®¹ä¸¢å¤±

**Architecture:** åœ¨ `write.md` ä¸­å¢åŠ æ–­ç‚¹ä¿å­˜å’Œæ¢å¤é€»è¾‘ã€‚å†™ä½œè¿‡ç¨‹ä¸­å®šæœŸä¿å­˜è¿›åº¦åˆ° `stories/*/spec/tracking/write-checkpoint.json`ï¼ŒåŒ…å«å½“å‰ç« èŠ‚å·ã€å·²å†™å­—æ•°ã€å·²å†™å†…å®¹æ‘˜è¦ã€åŠ è½½çš„ä¸Šä¸‹æ–‡æ‘˜è¦ã€‚æ¢å¤æ—¶è¯»å– checkpoint æ–‡ä»¶ï¼Œè·³è¿‡å·²å®Œæˆçš„æ­¥éª¤ã€‚

**Tech Stack:** Markdown æ¨¡æ¿ã€JSON æ•°æ®

---

### Task 15.1: å®šä¹‰ checkpoint æ•°æ®ç»“æ„

**Files:**
- æ–‡æ¡£å®šä¹‰ï¼ˆå†™å…¥ plan æ–‡ä»¶ï¼Œå®é™…æ–‡ä»¶ç”± /write è¿è¡Œæ—¶ç”Ÿæˆï¼‰

**Step 1: å®šä¹‰ write-checkpoint.json ç»“æ„**

```json
{
  "version": "1.0",
  "storyDir": "[æ•…äº‹ç›®å½•å]",
  "chapter": {
    "number": "[ç« èŠ‚ç¼–å·]",
    "title": "[ç« èŠ‚æ ‡é¢˜]",
    "taskId": "[å¯¹åº”çš„ tasks.md ä»»åŠ¡ID]"
  },
  "progress": {
    "status": "in_progress",
    "wordsWritten": 0,
    "targetWords": 3000,
    "sectionsCompleted": 0,
    "totalSections": 3,
    "lastSectionSummary": ""
  },
  "context": {
    "loadedResources": [
      "[å·²åŠ è½½çš„èµ„æºæ–‡ä»¶è·¯å¾„åˆ—è¡¨]"
    ],
    "charactersFocused": ["[å½“å‰ç« èŠ‚æ¶‰åŠçš„è§’è‰²]"],
    "previousChapterEnding": "[ä¸Šä¸€ç« æœ€åä¸€æ®µæ‘˜è¦]",
    "currentTask": "[å½“å‰å†™ä½œä»»åŠ¡æè¿°]"
  },
  "content": {
    "filePath": "[å½“å‰ç« èŠ‚æ–‡ä»¶è·¯å¾„]",
    "lastWrittenLine": 0,
    "contentHash": "[å·²å†™å†…å®¹çš„ hashï¼Œç”¨äºæ£€æµ‹å¤–éƒ¨ä¿®æ”¹]"
  },
  "timestamps": {
    "createdAt": "[ISOæ—¥æœŸ]",
    "updatedAt": "[ISOæ—¥æœŸ]",
    "expiresAt": "[ISOæ—¥æœŸï¼Œ24å°æ—¶åè¿‡æœŸ]"
  }
}
```

---

### Task 15.2: åœ¨ write.md ä¸­æ’å…¥æ–­ç‚¹ä¿å­˜é€»è¾‘

**Files:**
- Modify: `templates/commands/write.md`ï¼ˆåœ¨å†™ä½œæ‰§è¡Œæµç¨‹ä¸­æ’å…¥ï¼‰

**Step 1: åœ¨å†™ä½œæ‰§è¡Œæµç¨‹å¼€å¤´æ·»åŠ  checkpoint æ¢å¤æ£€æµ‹**

åœ¨ `write.md` çš„ã€Œå†™ä½œæ‰§è¡Œæµç¨‹ã€ç« èŠ‚å¼€å¤´ï¼ˆæ­£å¸¸æ¨¡å¼æµç¨‹çš„æœ€å‰é¢ï¼‰ï¼Œæ’å…¥ï¼š

```markdown

### æ–­ç‚¹ç»­å†™æœºåˆ¶

#### æ¢å¤æ£€æµ‹

åœ¨å¼€å§‹å†™ä½œå‰ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªå®Œæˆçš„ checkpointï¼š

1. è¯»å– `stories/*/spec/tracking/write-checkpoint.json`
2. å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸” `status` ä¸º `in_progress`ï¼š
   - æ£€æŸ¥ `expiresAt` æ˜¯å¦å·²è¿‡æœŸï¼ˆè¶…è¿‡ 24 å°æ—¶è§†ä¸ºè¿‡æœŸï¼‰
   - å¦‚æœæœªè¿‡æœŸï¼Œå‘ç”¨æˆ·æç¤ºï¼š

```
ğŸ“ å‘ç°æœªå®Œæˆçš„å†™ä½œè¿›åº¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“– ç« èŠ‚ï¼šç¬¬ [N] ç«  â€” [æ ‡é¢˜]
ğŸ“Š è¿›åº¦ï¼š[å·²å†™å­—æ•°]/[ç›®æ ‡å­—æ•°]ï¼ˆ[X]%ï¼‰
â° ä¸Šæ¬¡å†™ä½œï¼š[æ—¶é—´]

é€‰æ‹©æ“ä½œï¼š
1. ç»§ç»­å†™ä½œï¼ˆä»æ–­ç‚¹æ¢å¤ï¼‰
2. é‡æ–°å¼€å§‹ï¼ˆä¸¢å¼ƒå·²æœ‰è¿›åº¦ï¼‰
3. æŸ¥çœ‹å·²å†™å†…å®¹
```

   - å¦‚æœç”¨æˆ·é€‰æ‹©ã€Œç»§ç»­å†™ä½œã€â†’ è·³è½¬åˆ°ã€Œæ–­ç‚¹æ¢å¤æµç¨‹ã€
   - å¦‚æœç”¨æˆ·é€‰æ‹©ã€Œé‡æ–°å¼€å§‹ã€â†’ åˆ é™¤ checkpointï¼Œæ‰§è¡Œæ­£å¸¸æµç¨‹
   - å¦‚æœå·²è¿‡æœŸ â†’ æç¤ºè¿‡æœŸï¼Œè¯¢é—®æ˜¯å¦ä»è¦æ¢å¤

3. å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ â†’ æ‰§è¡Œæ­£å¸¸å†™ä½œæµç¨‹

#### æ–­ç‚¹æ¢å¤æµç¨‹

å½“ç”¨æˆ·é€‰æ‹©ä»æ–­ç‚¹æ¢å¤æ—¶ï¼š

1. **è·³è¿‡èµ„æºåŠ è½½**ï¼šä½¿ç”¨ checkpoint ä¸­è®°å½•çš„ `loadedResources` åˆ—è¡¨ï¼Œä»…é‡æ–°åŠ è½½è¿™äº›èµ„æºï¼ˆè€Œéæ‰§è¡Œå®Œæ•´çš„ä¸‰å±‚èµ„æºåŠ è½½ï¼‰
2. **æ¢å¤ä¸Šä¸‹æ–‡**ï¼š
   - è¯»å–å·²å†™çš„ç« èŠ‚å†…å®¹ï¼ˆä» `content.filePath`ï¼‰
   - éªŒè¯å†…å®¹ hash æ˜¯å¦åŒ¹é…ï¼ˆæ£€æµ‹å¤–éƒ¨ä¿®æ”¹ï¼‰
   - å¦‚æœ hash ä¸åŒ¹é…ï¼Œæç¤ºç”¨æˆ·å†…å®¹å·²è¢«å¤–éƒ¨ä¿®æ”¹ï¼Œè¯¢é—®æ˜¯å¦ä»¥å½“å‰æ–‡ä»¶å†…å®¹ä¸ºå‡†
3. **æ˜¾ç¤ºæ¢å¤æ‘˜è¦**ï¼š

```
âœ… å·²æ¢å¤å†™ä½œè¿›åº¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“– ç¬¬ [N] ç«  â€” [æ ‡é¢˜]
ğŸ“Š å·²å†™ï¼š[X] å­— / [Y] å­—
ğŸ“ ä¸Šæ¬¡å†™åˆ°ï¼š[æœ€åä¸€æ®µæ‘˜è¦]

âš¡ ç»§ç»­å†™ä½œ...
```

4. **ä»æ–­ç‚¹ç»§ç»­**ï¼šä»å·²å†™å†…å®¹çš„æœ«å°¾ç»§ç»­åˆ›ä½œ

#### æ–­ç‚¹ä¿å­˜æ—¶æœº

åœ¨å†™ä½œè¿‡ç¨‹ä¸­ï¼Œä»¥ä¸‹æ—¶æœºè‡ªåŠ¨ä¿å­˜ checkpointï¼š

1. **æ¯å®Œæˆä¸€ä¸ªåœºæ™¯/æ®µè½ç»„**åï¼ˆçº¦ 500-1000 å­—ï¼‰
2. **ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­æ—¶**ï¼ˆå¦‚æœæ£€æµ‹åˆ°å¯¹è¯ä¸­æ–­ï¼‰
3. **å†™ä½œå®Œæˆæ—¶**ï¼šå°† `status` æ›´æ–°ä¸º `completed`

**ä¿å­˜æ“ä½œ**ï¼š
- æ›´æ–° `write-checkpoint.json` ä¸­çš„ `progress` å’Œ `content` å­—æ®µ
- æ›´æ–° `timestamps.updatedAt`
- ä¸é˜»å¡å†™ä½œæµç¨‹ï¼ˆä¿å­˜æ“ä½œåº”å¿«é€Ÿå®Œæˆï¼‰

#### Checkpoint æ¸…ç†

- å†™ä½œæ­£å¸¸å®Œæˆåï¼šå°† `status` è®¾ä¸º `completed`ï¼Œä¿ç•™æ–‡ä»¶ä¾›å‚è€ƒ
- ä¸‹æ¬¡ `/write` æ–°ç« èŠ‚æ—¶ï¼šå¦‚æœä¸Šä¸€ä¸ª checkpoint çš„ `status` ä¸º `completed`ï¼Œè‡ªåŠ¨åˆ é™¤
- è¿‡æœŸçš„ checkpointï¼ˆè¶…è¿‡ 24 å°æ—¶ï¼‰ï¼šåœ¨ä¸‹æ¬¡ `/write` æ—¶æç¤ºå¹¶æ¸…ç†
```

**Step 2: éªŒè¯æ’å…¥ä½ç½®**

Run: `grep -n "æ–­ç‚¹ç»­å†™\|checkpoint\|æ¢å¤æ£€æµ‹" templates/commands/write.md`
Expected: æ–­ç‚¹ç»­å†™æœºåˆ¶å‡ºç°åœ¨å†™ä½œæ‰§è¡Œæµç¨‹ä¸­

**Step 3: Commit**

```bash
git add templates/commands/write.md
git commit -m "feat(write): add checkpoint-based resume mechanism for interrupted writing sessions"
```

---

### Task 15.3: æ›´æ–° write.md çš„ allowed-tools

**Files:**
- Modify: `templates/commands/write.md:1-9`ï¼ˆfrontmatterï¼‰

**Step 1: ç¡®è®¤ allowed-tools åŒ…å«å¿…è¦æƒé™**

æ£€æŸ¥ frontmatter ä¸­çš„ `allowed-tools` æ˜¯å¦å·²åŒ…å«ï¼š
- `Read` â€” è¯»å– checkpoint æ–‡ä»¶ âœ…ï¼ˆå·²æœ‰ï¼‰
- `Write` â€” å†™å…¥ checkpoint æ–‡ä»¶å’Œç« èŠ‚å†…å®¹ âœ…ï¼ˆå·²æœ‰ï¼‰
- `Edit` â€” æ›´æ–° checkpoint æ–‡ä»¶ âœ…ï¼ˆå·²æœ‰ï¼‰

Expected: æ— éœ€ä¿®æ”¹ allowed-tools

---

### Task 15.4: æ›´æ–° write.md çš„åç½®å¤„ç†

**Files:**
- Modify: `templates/commands/write.md`ï¼ˆåç½®å¤„ç†éƒ¨åˆ†ï¼‰

**Step 1: åœ¨åç½®å¤„ç†ä¸­æ·»åŠ  checkpoint å®Œæˆæ ‡è®°**

åœ¨ `/write` çš„åç½®å¤„ç†æµç¨‹ï¼ˆå­—æ•°éªŒè¯ã€è¿›åº¦æ›´æ–°ã€tracking æ›´æ–°ä¹‹åï¼‰ï¼Œæ·»åŠ ï¼š

```markdown
#### Checkpoint å®Œæˆæ ‡è®°

å†™ä½œæ­£å¸¸å®Œæˆåï¼Œæ›´æ–° checkpoint çŠ¶æ€ï¼š

```json
{
  "progress": {
    "status": "completed",
    "wordsWritten": [æœ€ç»ˆå­—æ•°]
  },
  "timestamps": {
    "updatedAt": "[å½“å‰æ—¶é—´]"
  }
}
```

å¦‚æœä¸éœ€è¦ä¿ç•™ checkpoint è®°å½•ï¼Œå¯ç›´æ¥åˆ é™¤ `write-checkpoint.json`ã€‚
```

**Step 2: Commit**

```bash
git add templates/commands/write.md
git commit -m "feat(write): add checkpoint completion marking in post-processing"
```

---

### Task 15.5: éªŒè¯æ–­ç‚¹ç»­å†™ä¸å¿«å†™æ¨¡å¼çš„å…¼å®¹æ€§

**Step 1: ç¡®è®¤ --fast æ¨¡å¼ä¹Ÿæ”¯æŒæ–­ç‚¹ç»­å†™**

å¿«å†™æ¨¡å¼ï¼ˆ`--fast`ï¼‰åº”è¯¥ï¼š
- âœ… æ”¯æŒ checkpoint æ¢å¤æ£€æµ‹ï¼ˆåœ¨ Fast-1 ä¹‹å‰æ‰§è¡Œï¼‰
- âœ… æ”¯æŒæ–­ç‚¹ä¿å­˜ï¼ˆåœ¨å†™ä½œè¿‡ç¨‹ä¸­ï¼‰
- âœ… æ¢å¤æ—¶ä½¿ç”¨å¿«å†™æ¨¡å¼çš„æœ€å°èµ„æºåŠ è½½ï¼ˆè€Œéå®Œæ•´åŠ è½½ï¼‰

**Step 2: ç¡®è®¤æµç¨‹é¡ºåº**

```
/write å¼€å§‹
  â†’ æ–­ç‚¹æ¢å¤æ£€æµ‹ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
    â†’ å¦‚æœ‰ checkpoint â†’ æ¢å¤æµç¨‹
    â†’ å¦‚æ—  checkpointï¼š
      â†’ æ£€æµ‹ --fast â†’ å¿«å†™æ¨¡å¼
      â†’ å¦åˆ™ â†’ æ­£å¸¸æ¨¡å¼
```

**Step 3: æœ€ç»ˆéªŒè¯**

```bash
git log --oneline -3
```
Expected: çœ‹åˆ° 2 ä¸ªç›¸å…³ commit
