# Guide.md 优化设计方案

## 概述

重新设计 `templates/commands/guide.md` 的推荐逻辑，从"列举多个选项"转变为"智能推荐最佳下一步"，解决当前命令过多导致用户迷茫的问题。

## 当前问题

1. **推荐逻辑不够智能**
   - 每个阶段列出 3-4 个操作选项，用户不知道选哪个
   - 无法根据异常情况（tracking 落后、角色缺席）自动调整推荐
   - 未考虑项目规模和写作阶段的差异

2. **阶段划分不清晰**
   - 8 个阶段有重复和冗余
   - 每个阶段的推荐操作过于分散
   - 缺乏"唯一最佳下一步"的明确指引

3. **用户场景**
   - 项目类型：全部是长篇，可能到 1000+ 章
   - 需要适应超长篇的特殊需求（分卷管理、跨卷上下文）

## 设计目标

1. **1 个主推荐 + 1-2 个备选**：清晰聚焦，减少决策负担
2. **异常自动优先**：P0 级别问题自动成为主推荐
3. **差异化建议**：长篇（50-300章）vs 超长篇（>300章）
4. **健康提示折叠**：P2 级别问题不干扰主流程

## 方案对比

### 方案 A：分层优先级推荐引擎（✅ 选择）

**核心思路**：建立 P0/P1/P2 三层优先级，自动计算"最佳下一步"

**优点**：
- 逻辑清晰，易理解
- 异常自动优先
- 易扩展（新增命令只需分配优先级）

**缺点**：
- 需要重写大部分逻辑

### 方案 B：智能决策树 + 上下文感知

**核心思路**：根据文件状态、时间间隔、项目规模走决策树

**优点**：推荐极度精准，能感知用户习惯

**缺点**：决策树复杂，维护成本高

### 方案 C：简化阶段 + 静态推荐表

**核心思路**：将 8 个阶段简化为 4 个，每个阶段固定推荐

**优点**：极简，易维护

**缺点**：不智能，无法检测异常

### 选择理由

方案 A 平衡了智能性和复杂度，符合长篇小说的复杂度需求，且易于扩展。

---

## 详细设计

### 1. 整体架构

**核心流程**：
```
1. 读取项目状态
   ↓
2. 计算项目规模（长篇/超长篇）
   ↓
3. 扫描 P0/P1/P2 三层优先级
   ↓
4. 选择最高优先级的主推荐
   ↓
5. 选择同级别备选 1-2 个
   ↓
6. 输出推荐 + 健康提示
```

**关键设计决策**：
- **P0 优先于一切**：即使在"写作期"，如果检测到写作断点或严重异常，P0 自动成为主推荐
- **同级别按规则排序**：如果 P1 级别有多个候选，按预定义规则选择
- **备选操作有意义**：不是简单罗列，而是"次优选择"

**示例输出结构**：
```
🎯 下一步推荐

▶️ /write 第5章 — 继续写作（已完成 4/30 章）

备选操作：
  • /recap --brief — 如果离开超过 1 天
  • /facts check — 检查设定事实一致性

⚠️ 健康提示（3 个问题）
  [折叠] 展开查看
```

### 2. 三层优先级体系

#### P0（阻塞级）- 必须立即处理

| 检测项 | 触发条件 | 推荐操作 |
|--------|---------|---------|
| 写作断点未恢复 | `write-checkpoint.json` 存在且 status=in_progress | /write [断点章节] |
| Tracking 严重落后 | 已写章节数 - tracking 更新章节数 > 3（长篇）或 > 2（超长篇）| /track --sync |
| 时间线冲突 | `timeline.json` 中检测到冲突标记 | /timeline --check |
| 伏笔超紧急 | `plot-tracker.json` 中任一伏笔 urgency > 0.9 | /track --check（查看伏笔详情）|
| Facts 冲突 | `story-facts.json` 存在且检测到规则失败 | /facts check |

#### P1（流程级）- 按创作流程推荐

```
空白项目 → /specify
规格草案 → /specify [继续完善] 或 /clarify
规格完成 → /plan
计划完成 → /tasks
任务就绪 → /write [第一章]
写作中 → /write [下一章]
离开>1天 → /recap（优先于 /write）
卷完成 → /analyze [本卷]
全书完成 → /checklist
```

#### P2（优化级）- 质量提升建议

| 检测项 | 触发条件 | 推荐操作 |
|--------|---------|---------|
| 角色长期缺席 | character-state.json 中角色缺席 > 8 章（超长篇）或 > 5 章（长篇）| /character list |
| 爽点间隔过长 | 最近 5 章无高潮标记 | /analyze --focus=hook |
| 风格偏移 | 检测到风格异常 | /analyze --focus=style |
| Tracking 轻微落后 | 落后 1-2 章 | /track --sync |
| 伏笔中等紧急 | urgency 0.5-0.9 | /track --check |

**优先级计算规则**：
- P0 中任一条件触发 → P0 成为主推荐
- 无 P0 → 按 P1 流程推荐
- P2 仅作为健康提示（折叠显示），不成为主推荐

### 3. 项目规模判断与差异化建议

#### 规模判断逻辑（组合判断）

```javascript
// 步骤 1：读取规划目标
从 specification.md frontmatter 读取：
  - target-words: 目标字数
  - story-type: 短篇/中篇/长篇

从 creative-plan.md 读取：
  - 总卷数
  - 总章节数规划

// 步骤 2：读取实际进度
从 content/ 统计：
  - 已写章节数
  - 已写字数

// 步骤 3：综合判断（针对长篇项目）
IF 总规划章数 > 500 或 已写 > 300 → 超长篇
ELSE IF 总规划章数 > 100 或 已写 > 50 → 长篇
ELSE → 长篇（默认）
```

#### 差异化建议规则

| 规模 | Tracking 策略 | 质量检查频率 | /recap 触发 | 分卷管理 |
|------|-------------|------------|-----------|---------|
| 长篇（50-300章）| 落后 > 3 章 → P0 | 每 5 章 | 离开 > 1 天 | 每卷末推荐 /analyze |
| 超长篇（>300章）| 落后 > 2 章 → P0 | 每 3 章 | 离开 > 1 天 | 每卷末**强制** /analyze，跨卷推荐 /recap |

#### 超长篇特殊优化

1. **分卷优先推荐**：
   - 卷末自动推荐 `/analyze [本卷]` + `/checklist`
   - 新卷开始前强制推荐 `/recap --full`（重建全局上下文）

2. **Tracking 严格检查**：
   - 超长篇 tracking 落后 > 2 章立即升级为 P0
   - 每 10 章自动推荐 `/track --check`

3. **角色管理加强**：
   - 超长篇角色缺席 > 8 章（而非 5 章）才警告
   - 每 20 章推荐执行 `/character list`

4. **写作阶段细分**：
```
卷内阶段（针对当前卷）：
  - 卷开篇（本卷前 20%）→ 不过度分析
  - 卷中期（20%-70%）→ 强调伏笔和节奏
  - 卷末期（>70%）→ 每 2 章提醒质量检查

跨卷阶段：
  - 卷末 → 强制 /analyze + /checklist
  - 卷间隙 → 推荐 /plan [下一卷]
  - 新卷开始前 → 强制 /recap --full
```

### 4. 推荐输出格式

#### 标准输出模板

```
📍 当前状态
━━━━━━━━━━━━━━━━━━━━
📊 进度：第 [N] 章 / 共 [M] 章（[X]%）
📚 当前卷：第 [V] 卷 / 共 [T] 卷
⏰ 距上次写作：[时间]

🎯 下一步推荐
━━━━━━━━━━━━━━━━━━━━
▶️ /write 第 [N+1] 章 — 继续写作

备选操作：
  • /recap --brief — 距上次写作已 2 天
  • /facts check — 检查设定事实一致性

⚠️ 健康提示（2 个问题）[可展开]
  • 角色「师姐」已 6 章未出场
  • 伏笔「身世之谜」紧急度 0.7
```

#### 不同场景的变体

**场景 1：空白项目**
```
🚀 欢迎开始新故事！

🎯 下一步推荐
━━━━━━━━━━━━━━━━━━━━
▶️ /specify [故事名] — 创建故事规格书

💡 完整流程：/specify → /plan → /tasks → /write
```

**场景 2：卷末**
```
🎉 第 [V] 卷写作完成！

📊 本卷统计：[N] 章，[M] 字

🎯 下一步推荐
━━━━━━━━━━━━━━━━━━━━
▶️ /analyze [故事名] --range=vol-[V] — 分析本卷质量（推荐）

备选操作：
  • /checklist — 执行卷末检查清单
  • /plan --detail vol-[V+1] — 规划下一卷
```

**场景 3：超长篇新卷开始**
```
📚 准备开始第 [V] 卷

🎯 下一步推荐
━━━━━━━━━━━━━━━━━━━━
▶️ /recap --full — 重建全局上下文（超长篇推荐）

备选操作：
  • /plan --detail vol-[V] — 查看本卷规划
  • /character list — 确认角色状态

💡 超长篇提示：新卷开始前建议执行完整 recap
```

**场景 4：P0 紧急情况**
```
📍 当前状态
━━━━━━━━━━━━━━━━━━━━
📊 进度：第 25 章 / 共 300 章（8%）

🔴 检测到紧急问题（优先处理）
━━━━━━━━━━━━━━━━━━━━
▶️ /track --sync — Tracking 数据落后 4 章

备选操作：
  • /write 第 26 章 — 同步后继续写作

💡 完成 tracking 同步后，可继续写作流程
```

### 5. 备选操作选择逻辑

#### 选择原则

- 最多 2 个备选
- 必须与主推荐**互补**，而非重复
- 按实用性排序（用户最可能需要的放前面）

#### 选择规则表

| 主推荐 | 备选 1 | 备选 2 | 逻辑 |
|--------|--------|--------|------|
| /write [章节] | /recap --brief（如离开>1天）| /facts check 或 /character list | 写作前准备 |
| /specify | /clarify（如有待定项）| - | 规格完善 |
| /plan | /character create | /specify --world | 规划前的准备工作 |
| /tasks | /plan --detail vol-X | /character list | 任务生成前的细化 |
| /track --sync（P0）| /write [继续] | - | 同步后继续写作 |
| /recap --full（新卷）| /plan --detail vol-X | /character list | 上下文重建后的准备 |
| /analyze [本卷] | /checklist | /plan [下一卷] | 卷末检查 |
| /facts check（P0）| /write [继续] | - | 修复后继续 |

#### 动态备选规则

```javascript
IF 离开时长 > 1 天 AND 主推荐是 /write
  → 备选 1 = /recap --brief

IF 检测到 P2 级别问题（角色缺席、伏笔中等紧急）
  → 备选 2 = 对应检查命令

IF 主推荐是流程类（/specify, /plan, /tasks）
  → 备选 = 流程的前置准备命令

IF 主推荐是 P0 紧急修复
  → 备选 1 = 修复后的正常流程
```

#### 不推荐的备选（避免噪音）

- ❌ 不把 `/guide` 作为备选（循环引用）
- ❌ 不把已完成阶段的命令作为备选
- ❌ 不把过于高级的分析作为备选（如刚开始写作就推荐 /analyze）

### 6. 健康提示（P2 级别）的展示逻辑

#### 折叠展示原则

- P2 级别问题默认折叠，不干扰主推荐
- 显示问题数量，用户可选择展开
- 按严重程度排序（高到低）

#### 严重程度计分规则

```javascript
角色缺席（长篇）：
  5-7 章 → 30 分
  8-10 章 → 50 分
  >10 章 → 70 分

角色缺席（超长篇）：
  8-10 章 → 30 分
  11-15 章 → 50 分
  >15 章 → 70 分

伏笔紧急度：
  0.5-0.6 → 20 分
  0.7-0.8 → 40 分
  0.8-0.9 → 60 分

tracking 落后：
  1 章 → 15 分
  2 章 → 30 分

风格偏移 → 25 分
爽点间隔 >5 章 → 35 分
```

#### 折叠显示格式

```
⚠️ 健康提示（3 个问题）[点击展开]

[展开后]
⚠️ 健康提示
━━━━━━━━━━━━━━━━━━━━
1. 角色「师姐」已 8 章未出场（严重）
   → /character list 查看所有角色状态

2. 伏笔「身世之谜」紧急度 0.75
   → /track --check 查看伏笔详情

3. Tracking 数据落后 2 章
   → /track --sync 同步更新
```

#### 显示控制

- 如果**无 P2 问题** → 不显示健康提示区域
- 如果**只有 1 个 P2 问题且分数 < 30** → 不显示（不重要）
- 如果**有高分 P2 问题（>60 分）** → 默认展开显示

#### 超长篇特殊规则

```
超长篇（>300 章）的健康提示放宽：
  - 角色缺席阈值：8 章（而非 5 章）
  - 但每 20 章强制提示一次角色管理
```

### 7. 实现要点与边界情况处理

#### 关键实现点

1. **状态检测的性能优化**
   - 只读取必要的文件头部（前 50 行）判断状态
   - 使用缓存避免重复读取
   - Tracking 文件只检测存在性和修改时间，不深度解析

2. **P0 级别的触发检测**
   ```
   写作断点：读取 write-checkpoint.json 的 status 字段
   Tracking 落后：比较 content/*.md 文件数 vs tracking-log.md 最后记录
   时间线冲突：检测 timeline.json 是否有 "conflict": true 标记
   伏笔紧急：读取 plot-tracker.json，检查 urgency > 0.9
   Facts 冲突：检测 story-facts.json 是否存在，调用 facts-checker
   ```

3. **离开时长计算**
   ```
   优先级：
   1. write-checkpoint.json 的 updatedAt
   2. 最新章节文件的修改时间
   3. tracking-log.md 的最后更新时间
   ```

#### 边界情况处理

| 边界情况 | 处理策略 |
|---------|---------|
| 项目完全空白（无任何文件）| 显示欢迎信息，主推荐 /specify |
| 文件不全（有 plan 但无 spec）| P0 警告："检测到异常状态，建议重新执行流程" |
| 多个 P0 同时触发 | 选择最紧急的（写作断点 > tracking > 其他）|
| creative-plan 存在但无卷数信息 | 默认为长篇（>100章）|
| 已写章节超过规划章节 | 提示更新 creative-plan |
| Tracking 文件损坏/格式错误 | P0：提示修复或重新初始化 |

#### 容错设计

- 任何文件读取失败 → 跳过该检测项，不阻塞整体推荐
- JSON 解析失败 → 降级为"文件存在性检测"
- 无法判断阶段 → 默认推荐 /guide（递归调用保护）

---

## 实现清单

### 核心逻辑重写

1. **状态检测模块**
   - 文件存在性检测
   - 项目规模判断（长篇/超长篇）
   - 离开时长计算

2. **P0/P1/P2 优先级扫描**
   - P0 阻塞级检测（5 个检测项）
   - P1 流程级判断（9 个阶段）
   - P2 优化级计分（5 个检测项）

3. **主推荐选择引擎**
   - 优先级计算
   - 同级别排序规则

4. **备选操作选择**
   - 静态规则表
   - 动态规则（离开时长、P2 问题）

5. **健康提示生成**
   - 严重程度计分
   - 折叠显示逻辑

### 输出格式模板

6. 标准输出模板（当前状态 + 主推荐 + 备选 + 健康提示）
7. 场景变体（空白项目、卷末、新卷开始、P0 紧急）

### 边界情况处理

8. 容错逻辑
9. 异常状态警告

---

## 后续工作

完成设计后，调用 `writing-plans` skill 生成实施计划。

## 附录：命令优先级分配表

| 命令 | P0 场景 | P1 场景 | P2 场景 |
|------|--------|---------|---------|
| /specify | - | 空白项目、规格草案 | - |
| /clarify | - | 规格有待定项 | - |
| /plan | - | 规格完成 | - |
| /tasks | - | 计划完成 | - |
| /write | 写作断点恢复 | 任务就绪、写作中 | - |
| /recap | - | 离开>1天（优先于 write）| - |
| /analyze | - | 卷末 | - |
| /checklist | - | 全书完成 | - |
| /track | tracking 落后 >3章 | - | tracking 落后 1-2章 |
| /timeline | 时间线冲突 | - | - |
| /facts | facts 冲突 | - | - |
| /character | - | - | 角色缺席 >5/8章 |
| /revise | - | - | 风格偏移 |
| /expert | - | - | - |
