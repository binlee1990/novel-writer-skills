# Task 39: `/tasks` 功能增强

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 增强 `/tasks` 命令：支持任务优先级、任务依赖关系、任务自动生成（从 plan 中提取）、任务完成度统计

**Architecture:** 在 `templates/commands/tasks.md` 中扩展任务管理能力。

**Tech Stack:** Markdown 模板

---

### Task 39.1: 读取现有 tasks.md 并评估缺失内容

**Files:**
- Read: `templates/commands/tasks.md`

**Step 1: 读取文件，记录已有内容和缺失部分**

需要确认以下能力是否已实现：
- [ ] 任务创建/编辑/删除
- [ ] 任务状态管理（待办/进行中/完成）
- [ ] 任务优先级
- [ ] 任务依赖关系
- [ ] 从 plan 自动生成任务
- [ ] 任务完成度统计

---

### Task 39.2: 添加任务优先级系统

**Files:**
- Modify: `templates/commands/tasks.md`

**Step 1: 在任务数据结构中添加优先级**

```markdown
#### 任务优先级

每个任务可设置优先级：

| 优先级 | 标记 | 含义 |
|--------|------|------|
| P0 | 🔴 | 紧急：阻塞写作进度 |
| P1 | 🟠 | 重要：影响质量但不阻塞 |
| P2 | 🟡 | 普通：常规写作任务 |
| P3 | 🟢 | 低优：优化/润色类 |

##### 优先级排序视图

```
📋 任务列表（按优先级）
━━━━━━━━━━━━━━━━━━━━

🔴 P0 紧急：
  □ 回收「身世之谜」伏笔（已延迟 5 章）
  □ 修复第 18 章时间线冲突

🟠 P1 重要：
  □ 写第 26 章（主线推进）
  □ 安排师姐出场（已缺席 7 章）

🟡 P2 普通：
  □ 写第 27 章
  □ 补充城主之女的背景设定

🟢 P3 低优：
  ☑ 润色第 20 章对话
  □ 更新角色关系图
```
```

---

### Task 39.3: 添加任务依赖关系

**Files:**
- Modify: `templates/commands/tasks.md`

**Step 1: 添加依赖关系管理**

```markdown
#### 任务依赖关系

任务之间可以设置依赖关系：

```
📋 任务依赖图
━━━━━━━━━━━━━━━━━━━━

[完善力量体系设定] ──→ [写第 26 章战斗场景]
                          │
                          ↓
                    [写第 27 章战后处理] ──→ [写第 28 章新篇章]

[安排师姐出场] ──→ [写第 26 章]（师姐在此章出场）

⚠️ 阻塞任务：
- 「完善力量体系设定」阻塞了 3 个下游任务
  → 建议优先处理
```

##### 依赖检测

自动检测隐含依赖：
- 章节任务自动按顺序依赖（第 N+1 章依赖第 N 章）
- 设定任务自动阻塞引用该设定的写作任务
- 伏笔回收任务依赖伏笔埋设任务
```

---

### Task 39.4: 添加从 plan 自动生成任务

**Files:**
- Modify: `templates/commands/tasks.md`

**Step 1: 添加自动生成逻辑**

```markdown
#### 从计划自动生成任务

**触发条件**：`$ARGUMENTS` 包含 `--from-plan`

**执行流程**：
1. 读取 `creative-plan.md`
2. 提取每章的计划内容
3. 为每章生成一个写作任务
4. 自动设置依赖关系（顺序依赖）
5. 从 `/analyze` 反馈中提取修复任务
6. 从 `/track --check` 中提取维护任务

##### 生成规则

| 来源 | 生成的任务类型 | 优先级 |
|------|--------------|--------|
| 章节计划 | 写作任务 | P2 |
| 伏笔回收计划 | 伏笔任务 | 根据紧急度 P0-P2 |
| 角色出场计划 | 角色任务 | P1-P2 |
| 分析反馈 | 修复任务 | P0-P1 |
| tracking 落后 | 维护任务 | P1 |

##### 输出示例

```
📋 从计划生成任务
━━━━━━━━━━━━━━━━━━━━

已生成 8 个任务：

🟡 P2 写作任务（5 个）：
  □ 写第 26 章：师姐出场 + 主角突破
  □ 写第 27 章：新敌人登场
  □ 写第 28 章：情报收集
  □ 写第 29 章：潜入敌营
  □ 写第 30 章：卷末高潮

🟠 P1 伏笔任务（2 个）：
  □ 在第 26 章回收「身世之谜」伏笔
  □ 在第 28 章埋设「远古秘密」伏笔

🔴 P0 修复任务（1 个）：
  □ 修复第 18 章时间线冲突

是否确认生成？[Y/N]
```
```

---

### Task 39.5: 添加任务完成度统计

**Files:**
- Modify: `templates/commands/tasks.md`

**Step 1: 添加统计输出**

```markdown
#### 任务完成度统计

**触发条件**：`$ARGUMENTS` 包含 `--stats`

```
📊 任务统计
━━━━━━━━━━━━━━━━━━━━

总任务：[N] 个
  ✅ 已完成：[A] 个（[X]%）
  🔄 进行中：[B] 个
  ⏳ 待办  ：[C] 个
  ❌ 已取消：[D] 个

按优先级：
  🔴 P0：[完成]/[总数]
  🟠 P1：[完成]/[总数]
  🟡 P2：[完成]/[总数]
  🟢 P3：[完成]/[总数]

按类型：
  写作任务：[完成]/[总数]
  修复任务：[完成]/[总数]
  维护任务：[完成]/[总数]

进度条：▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░ [X]%
```
```

**Step 2: Commit**

```bash
git add templates/commands/tasks.md
git commit -m "feat(tasks): enhance with priority system, dependency management, auto-generation from plan, and completion statistics"
```
