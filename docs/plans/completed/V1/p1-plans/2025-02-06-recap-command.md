# /recap 上下文重建命令实现计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标：** 创建 `/recap` Slash Command，自动重建创作上下文，解决"30 章后失焦"和"隔天续写困难"问题

**架构：** Slash Command + 智能汇总算法，读取追踪数据和最近章节，生成结构化的上下文简报

**技术栈：** Markdown Command 文件，集成 character-state.json、plot-tracker.json、relationships.json 等追踪系统

---

## 背景与动机

### 核心问题

**场景 1：隔天/隔周续写**
```
作者昨天写到第 28 章，今天回来继续写第 29 章：
- 忘记角色当前状态（林晓现在和谁在一起？关系如何？）
- 忘记未解决的伏笔（那个神秘包裹后来怎么了？）
- 忘记情节进展到哪里（主线推进到哪一步了？）
- 忘记角色情感走向（男女主现在是什么关系？）
```

**场景 2：30 章后失焦**
```
写到第 35 章时，AI 开始：
- 遗忘前期设定（角色性格变了）
- 遗忘伏笔（重要线索没有回收）
- 遗忘关系网（角色关系混乱）
```

**现有方案的不足**：
- `pre-write-checklist` 强制加载 9 个文件 → 但文件可能内容过时
- 手动回顾前几章 → 耗时且容易遗漏
- 依赖记忆 → 不可靠

### 价值主张

1. **自动汇总关键信息** - 5 分钟内重建完整上下文
2. **智能优先级排序** - 突出最重要的信息（未解决伏笔、角色状态变化）
3. **结构化呈现** - 按类别组织，易于快速扫描
4. **与追踪系统深度集成** - 利用已有的 tracking 数据
5. **减轻认知负担** - 解放作者的"工作记忆"

---

## Task 1: 研究现有追踪系统和相关命令

**Files:**
- Read: `templates/commands/track.md`
- Read: `templates/commands/plot-check.md`
- Read: `spec/tracking/plot-tracker.json` (如果存在示例)
- Read: `spec/tracking/character-state.json` (如果存在示例)
- Read: `spec/tracking/relationships.json` (如果存在示例)
- Read: `templates/skills/quality-assurance/pre-write-checklist/SKILL.md`

**Step 1: 分析追踪系统数据结构**

```bash
# 查找所有追踪相关文件
find templates/ spec/ -name "*track*" -o -name "*state*" -o -name "*relationships*"
```

**目的：** 了解有哪些数据可用于上下文重建

**Step 2: 分析现有命令的输出格式**

```bash
# 查看 track 和 plot-check 命令
cat templates/commands/track.md
cat templates/commands/plot-check.md
```

**目的：** 理解用户已经熟悉的输出格式，保持一致性

**Step 3: 提取可复用的逻辑**

- `/track` 命令如何读取和更新追踪数据
- `/plot-check` 如何验证一致性
- `pre-write-checklist` 如何加载核心文件

---

## Task 2: 设计 recap.md 命令结构

**内容设计：**

```markdown
---
description: 自动重建创作上下文，汇总角色状态、未解决伏笔、情节进展和关系网络
---

# /recap - 上下文重建

## 目标

在隔天/隔周续写前，或写到 30+ 章后感觉失焦时，使用本命令快速重建完整的创作上下文。

**5 分钟内回答**：
- 角色现在在哪？状态如何？
- 主线情节推进到哪一步了？
- 有哪些未解决的伏笔和悬念？
- 角色关系网络是什么状态？
- 上一章的结尾是什么？（续写衔接点）

## 执行流程

### 阶段 1: 数据采集（自动）

**读取以下文件（按优先级）**：

#### 必读文件（如果不存在则警告）
1. `spec/tracking/character-state.json` - 角色当前状态
2. `spec/tracking/plot-tracker.json` - 情节追踪
3. `spec/tracking/relationships.json` - 关系网络
4. `stories/[current]/specification.md` - 故事规格
5. `stories/[current]/creative-plan.md` - 创作计划
6. `stories/[current]/tasks.md` - 任务清单

#### 最近内容文件
7. 最近 3-5 章的章节文件（`stories/[current]/content/chapter-XX.md`）
8. `spec/tracking/timeline.json` - 时间线

#### 辅助文件（可选）
9. `.specify/memory/constitution.md` - 创作宪法
10. `spec/knowledge/character-profiles.md` - 角色档案

### 阶段 2: 智能汇总

**按以下结构生成上下文简报**：

---

## 📋 上下文简报

生成日期：[当前日期]
故事名称：[从 specification.md 提取]
当前进度：第 [N] 章 / 预计 [M] 章

---

### 1. 角色当前状态 🎭

**主要角色**（按重要性排序）

**[角色名]** (主角)
- **位置**：[当前所在地]
- **状态**：[物理/情感状态]
- **目标**：[当前追求的目标]
- **弧线阶段**：[8 阶段模型的哪个阶段]
- **最近变化**：[最后一次重要变化，章节号]
- **重要装备/物品**：[如果有]

**[角色名 2]**
[同上格式]

**次要角色快速参考**：
- 角色 A：[一句话状态]
- 角色 B：[一句话状态]

**⚠️ 注意事项**：
- [从 character-state.json 提取的警告，例如"林晓已 10 章未出现"]

---

### 2. 主线情节进展 📖

**故事当前位置**（三幕结构）
```
第一幕 [====] 完成
第二幕 [===>....] 进行中（60%）
第三幕 [.......] 未开始
```

**主要情节线状态**

**主线：[主线名称]**
- **当前状态**：[进行中/暂停/完成]
- **最新进展**：[一句话概括]（第 [N] 章）
- **下一步行动**：[根据 creative-plan.md 提取]

**副线 A：[副线名称]**
- **当前状态**：[进行中/暂停/完成]
- **最新进展**：[一句话概括]（第 [N] 章）

**副线 B：[副线名称]**
[同上]

**已完成的情节线**：
- ✅ [情节线名称]（第 [X] 章完成）

---

### 3. 未解决的伏笔与悬念 🔍

**高优先级（需尽快处理）**

⏰ **[伏笔/悬念描述]**
- **埋下时间**：第 [N] 章
- **已经过**：[X] 章（⚠️ 警告：超过 15 章未处理）
- **计划解决**：第 [M] 章（根据 creative-plan.md）
- **处理建议**：[如果超期，给出建议]

⏰ **[伏笔 2]**
[同上]

**中优先级（正常节奏）**

⏳ **[伏笔描述]**
- **埋下时间**：第 [N] 章
- **已经过**：[X] 章
- **计划解决**：第 [M] 章

**低优先级（长线伏笔）**

📌 **[伏笔描述]**
[同上，但标注为长期伏笔]

---

### 4. 角色关系网络 💞

**关系状态矩阵**

```
林晓 ←→ 陈雨：暧昧期（↗ 好感度上升）
      最近互动：第 28 章，雨中对话

林晓 ←→ 张伟：朋友（→ 稳定）
      最近互动：第 26 章，并肩作战

陈雨 ←→ 李明：敌对（↘ 恶化中）
      最近互动：第 27 章，公开冲突
      ⚠️ 冲突升级，需要关注
```

**关系变化趋势**（最近 5 章）
- ↗ 林晓 & 陈雨：从陌生到暧昧（快速升温）
- ↘ 陈雨 & 李明：从合作到敌对（关系破裂）
- → 其他关系保持稳定

---

### 5. 上一章回顾 📄

**第 [N] 章：[章节标题]**（[字数] 字）

**核心事件**：
- [事件 1]
- [事件 2]
- [事件 3]

**章节结尾**（续写衔接点）：
> [引用上一章最后 2-3 段原文]

**结尾状态**：
- 悬念：[有/无，如果有，描述]
- 时间点：[故事内时间]
- 地点：[角色所在位置]

**下一章衔接建议**：
- [根据 tasks.md 和 creative-plan.md 提取的下一章任务]

---

### 6. 时间线快照 ⏰

**故事内时间**：
- 开始时间：[年月日]
- 当前时间：[年月日]
- 已过时长：[X 天/月/年]

**重要时间节点**（倒序，最近 5 个）：
- 第 [N] 章：[事件]（[故事内日期]）
- 第 [N-1] 章：[事件]（[故事内日期]）
- ...

**⚠️ 时间线问题**（如果有）：
- [从 timeline.json 检测的矛盾]

---

### 7. 创作状态检查 ✅

**完成度**：
- 已写章节：[N] / 预计 [M] 章（[X]%）
- 剩余字数预估：[N] 万字

**节奏检查**（最近 5 章）：
```
章节    紧张度
24      ████░░░░░░ 4
25      ███████░░░ 7
26      █████░░░░░ 5
27      ████████░░ 8
28      ████░░░░░░ 4
```
- 节奏评估：[有起伏/过于平淡/过于紧张]

**任务清单状态**（从 tasks.md）：
- ✅ 已完成：[N] 项
- 🔄 进行中：[M] 项
- ⏸️ 待办：[K] 项

**下一步关键任务**（Top 3）：
1. [任务 1]
2. [任务 2]
3. [任务 3]

---

### 8. 快速参考卡片 🎯

**写下一章前必须记住**：

📍 **当前位置**：[角色在哪，什么状态]

🎯 **下一章目标**：[根据 creative-plan.md]

⚠️ **注意事项**：
- [从一致性检查中提取的警告]
- [长时间未出现的角色]
- [超期未解决的伏笔]

💡 **灵感提示**：
- [根据故事类型和当前阶段，从知识库提取的建议]
- [例如：言情小说在这个阶段应该有的情感节拍]

---

## 📊 上下文简报结束

**建议行动**：
1. 如果有 ⚠️ 警告，先处理警告项
2. 重读上一章结尾，找到续写衔接点
3. 确认下一章任务
4. 执行 `/write` 开始创作

**数据更新提醒**：
- 本简报基于当前追踪数据生成
- 如追踪数据过时，请先执行 `/track` 更新
- 建议每写 3-5 章执行一次 `/recap`

---
```

### 阶段 3: 数据处理逻辑

**优先级判断算法**：

```python
# 伏笔优先级判断
def calculate_foreshadow_priority(foreshadow):
    chapters_since = current_chapter - foreshadow.planted_chapter
    planned_resolve = foreshadow.planned_resolve_chapter

    if chapters_since > 15:
        return "high"  # 超期未处理
    elif planned_resolve - current_chapter <= 3:
        return "high"  # 即将需要解决
    elif chapters_since > 8:
        return "medium"
    else:
        return "low"

# 角色状态警告
def check_character_absence(character):
    chapters_since_appearance = current_chapter - character.last_appearance
    if character.importance == "major" and chapters_since_appearance > 10:
        return f"⚠️ {character.name} 已 {chapters_since_appearance} 章未出场"
```

### 阶段 4: 集成点

**与现有命令的关系**：

| 命令 | 关系 | 数据流 |
|------|------|--------|
| `/track` | 前置依赖 | `/track` 更新数据 → `/recap` 读取数据 |
| `/plot-check` | 互补 | `/plot-check` 验证一致性 → `/recap` 展示警告 |
| `/write` | 后续流程 | `/recap` 重建上下文 → `/write` 执行写作 |
| `pre-write-checklist` | 集成 | `/recap` 简报可作为 pre-write 的一部分 |

---

## 输出格式

**命令执行后输出**：

1. **Markdown 格式的上下文简报**（如上设计）
2. **可选：保存到文件**
   - 路径：`stories/[current]/recap-chapter-[N].md`
   - 用途：历史记录，可查看之前某个时间点的上下文状态

## 使用场景

### 场景 1：隔天续写
```
用户："昨天写到 28 章，今天继续写 29 章，先给我回顾一下上下文"
AI："执行 /recap..."
[输出上下文简报]
用户："好的，现在开始写 29 章"
```

### 场景 2：长篇失焦诊断
```
用户："写到 35 章了，感觉有点乱，帮我梳理一下"
AI："执行 /recap..."
[输出简报，发现 3 个超期伏笔，2 个角色长期未出现]
AI："⚠️ 检测到以下问题需要注意..."
```

### 场景 3：计划调整
```
用户："我想调整后面的情节，先看看现在的状态"
AI："执行 /recap..."
[输出简报]
用户："好，我要把副线 B 提前..."
```

---

## 与 Skills 的集成

`pre-write-checklist` Skill 可以建议用户：
```
⚠️ 检测到距离上次 /recap 已超过 10 章，建议重新执行 /recap 刷新上下文。
```

## 高级功能（可选，未来扩展）

1. **对比模式**
   ```
   /recap --compare chapter-20
   # 对比第 20 章时的状态 vs 现在的状态
   # 展示变化趋势
   ```

2. **简化模式**
   ```
   /recap --brief
   # 只输出快速参考卡片，适合快速刷新记忆
   ```

3. **导出模式**
   ```
   /recap --export
   # 导出为 PDF 或独立文件，方便分享给合作者
   ```

## 检查清单

命令设计完成后验证：
- [ ] 包含所有 8 个核心部分
- [ ] 优先级算法逻辑清晰
- [ ] 与追踪系统数据结构匹配
- [ ] 输出格式易于快速扫描
- [ ] 与现有命令集成良好

---

**核心价值**：
让作者在 5 分钟内从"完全忘记"到"胸有成竹"，这是解决长篇创作最大痛点的关键命令。
```

---

## Task 3: 编写 recap.md 命令文件

**Files:**
- Create: `templates/commands/recap.md`

**Step 1: 编写命令头部和目标**

（按 Task 2 的设计内容编写）

**Step 2: 编写执行流程**

（详细说明 3 个阶段：数据采集、智能汇总、输出）

**Step 3: 编写示例输出**

包含完整的上下文简报模板

**预估长度：** 400-600 行

---

## Task 4: 创建配套的数据处理逻辑文档

**Files:**
- Create: `docs/recap-algorithm.md`

**内容：** 详细说明
- 伏笔优先级判断算法
- 角色状态警告逻辑
- 关系变化趋势计算
- 节奏评估方法

**目的：** 为 AI 提供明确的数据处理指导

---

## Task 5: 更新相关文档

**Files:**
- Modify: `templates/commands/write.md`
- Modify: `templates/skills/quality-assurance/pre-write-checklist/SKILL.md`
- Modify: `docs/commands.md`

**Step 1: 在 write.md 中添加 /recap 建议**

```markdown
### 写作前准备（可选但推荐）

如果距离上次写作已超过 1 天，或已写超过 30 章：
- 执行 `/recap` 重建上下文
- 快速扫描简报中的关键信息
- 确认无 ⚠️ 警告后再开始写作
```

**Step 2: 在 pre-write-checklist 中集成检测**

```markdown
## 上下文新鲜度检查

检测：
- 距离上次写作时间
- 距离上次 /recap 的章节数

如果任一条件满足：
- 超过 24 小时未写作
- 距离上次 /recap 超过 10 章

则建议：
> 💡 建议先执行 `/recap` 刷新上下文，再开始写作。
```

**Step 3: 更新命令文档**

在 `docs/commands.md` 中添加 `/recap` 的完整说明

---

## Task 6: 测试用例设计

**测试场景：**

### 场景 1：新手测试（追踪数据不完整）

**初始状态：**
- 只有 specification.md 和前 5 章内容
- 没有 tracking 数据

**执行：** `/recap`

**Expected：**
- 警告：追踪数据缺失
- 建议：先执行 `/track-init` 和 `/track`
- 仍然输出基于现有数据的简化简报

### 场景 2：中篇测试（15 章）

**初始状态：**
- 完整的 tracking 数据
- 15 章内容
- 2 个未解决伏笔

**执行：** `/recap`

**Expected：**
- 完整的 8 部分简报
- 伏笔优先级正确标注
- 角色状态准确反映

### 场景 3：长篇测试（35 章，有问题）

**初始状态：**
- 35 章内容
- 1 个伏笔超期 20 章未处理
- 1 个主要角色 12 章未出现
- 最近 5 章节奏评分都是 5（平淡）

**执行：** `/recap`

**Expected：**
- ⚠️ 高优先级警告正确显示
- 节奏评估标注"过于平淡"
- 给出处理建议

---

## Task 7: 验证和提交

**验证标准：**
- [ ] 命令文件 400-600 行
- [ ] 包含完整的 8 部分简报结构
- [ ] 优先级算法逻辑清晰
- [ ] 与 tracking 系统集成
- [ ] 测试用例通过
- [ ] 文档更新完成

**提交：**

```bash
git add templates/commands/recap.md
git add docs/recap-algorithm.md
git add docs/commands.md
git commit -m "feat(commands): 添加 /recap 上下文重建命令

- 自动汇总角色状态、情节进展、未解决伏笔
- 智能优先级排序和警告系统
- 8 部分结构化简报（角色/情节/伏笔/关系等）
- 与 tracking 系统深度集成
- 解决 30 章后失焦和隔天续写困难问题

Closes: P1 优先级任务 #1"
```

---

## 预估工作量

- Task 1-2: 研究和设计 - 2 小时
- Task 3: 编写命令文件 - 2-3 小时
- Task 4: 算法文档 - 1 小时
- Task 5: 集成更新 - 1 小时
- Task 6-7: 测试验证 - 1-2 小时

**总计：** 7-9 小时

---

## 成功标准

**用户反馈目标：**
- "5 分钟就能想起所有关键信息"
- "不再害怕隔天续写"
- "30 章后依然清楚知道故事在哪"

**技术指标：**
- 简报生成时间 < 10 秒
- 信息准确率 > 95%
- 警告召回率 > 90%（真实问题能被检测到）
