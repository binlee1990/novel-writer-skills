# /expand 命令上下文重载设计

日期：2026-02-19

## 问题

在同一对话中连续执行多次 /write 后再执行 /expand，出现四个叠加问题：

1. **对话上下文污染**：多章 /write 的生成过程占满上下文窗口，/expand 时 AI 注意力被稀释
2. **tracking 数据累积失真**：/write 批量生成后期概要质量下降，tracking 数据跟着失真
3. **expand 资源加载不够充分**：当前不加载 specification.md 和 creative-plan.md，缺少故事全局视角
4. **会话级复用规则有害**：CLAUDE.md 中"已加载资源不重新读取"规则导致 /expand 使用过时的 tracking 数据

## 方案选择

选择方案 B：上下文重置 + 扩大资源加载。从命令模板层面解决上下文污染，同时扩大资源加载范围。

## 设计详情

### 1. 上下文隔离声明

在 /expand 命令模板顶部（参数解析之前）加入强制指令：

```
## 上下文隔离（强制）

本命令的所有创作资源必须从文件系统重新加载，禁止依赖本对话中之前任何 /write 或其他命令的生成过程和中间记忆。

具体规则：
- 忽略对话历史中所有 /write 生成的概要内容，以文件系统中的 synopsis.md 为唯一真实来源
- 忽略对话历史中所有 tracking 文件的中间状态，重新从文件读取最新版本
- 不复用对话中已加载的 style-reference.md 或 anti-ai.md，重新读取
```

### 2. 3 层资源加载结构

将当前 6 项资源扩展为 3 层结构：

**第 1 层 — 全局视角（新增）**
- specification.md 摘要（100字）：类型 + 主角 + 核心冲突
- creative-plan.md 当前卷大纲：当前章所属卷的段落

**第 2 层 — 章节核心（保持）**
- 当前章概要全文（200-500字）
- 前一章正文末尾（500-800字），未扩写则用前一章概要代替

**第 3 层 — 细节支撑（扩展）**
- 本章出场角色状态：从 character-state.json 提取（保持）
- 本章活跃伏笔：从 plot-tracker.json 提取（保持）
- 本章相关角色关系（新增）：从 relationships.json 提取本章出场角色之间的关系条目
- 风格参考：style-reference.md 全文（保持）
- 反AI规范：anti-ai.md 全文（保持）

**上下文预算**：

| 层级 | 预估字数 |
|------|---------|
| 第 1 层 全局 | 200-400 字 |
| 第 2 层 章节 | 700-1300 字 |
| 第 3 层 细节 | 800-1500 字 |
| **总计** | **1700-3200 字** |

### 3. 执行步骤调整

**步骤 2 — 资源加载（重写）**
- 明确标注"从文件系统重新加载，不复用对话缓存"
- 按第 1 层 → 第 2 层 → 第 3 层顺序加载
- 每层加载完后做上下文预算检查，超出预算则截断（如角色关系条目过多时只取最核心的 5 条）

**步骤 3 — 扩写正文（增强）**
- 新增原则"全局一致性"：正文必须与 specification.md 的类型定位和 creative-plan.md 的卷级设计保持一致
- 新增原则"角色关系驱动"：对话和互动必须体现 relationships.json 中的关系动态

**步骤 5 — 批量模式（增强）**
- 每章都重新从文件系统加载资源（前一章扩写可能更新了 tracking）
- 声明："批量模式中每章视为独立的扩写任务，不复用前一章扩写过程中的中间状态"

### 4. CLAUDE.md 会话级复用规则修改

将当前的统一复用规则改为分命令策略：

```
会话级资源复用规则：
- /specify、/plan、/write 之间：可复用已加载资源，不重新读取
- /expand、/analyze：必须从文件系统重新加载所有资源，不复用对话缓存
- 例外：用户明确要求"重新加载"时，任何命令都重新读取
```

### 5. allowed-tools 更新

/expand 命令的 allowed-tools 增加：
- `Read(//stories/**/specification.md)`
- `Read(//stories/**/creative-plan.md)`
- `Read(//tracking/relationships.json)`

## 涉及文件

1. `templates/commands/expand.md` — 主要修改
2. `templates/dot-claude/CLAUDE.md` — 会话级复用规则修改
