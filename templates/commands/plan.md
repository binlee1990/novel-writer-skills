---
description: 基于故事规格制定技术实现方案
argument-hint: [技术偏好和选择] [--detail vol-XX]
allowed-tools: Read(//stories/**/specification.md), Read(stories/**/specification.md), Read(//stories/**/creative-plan.md), Read(stories/**/creative-plan.md), Read(//plugins/**), Read(plugins/**), Write(//stories/**/creative-plan.md), Write(stories/**/creative-plan.md), Read(//memory/constitution.md), Read(memory/constitution.md), Bash(find:*), Bash(grep:*), Bash(*)
model: claude-sonnet-4-5-20250929
scripts:
  sh: .specify/scripts/bash/plan-story.sh
  ps: .specify/scripts/powershell/plan-story.ps1
---

用户输入：$ARGUMENTS

## 目标

将"要创造什么"（规格）转化为"如何创造"（计划）。这是从需求到实现的关键转换。

## 参数解析

1. **故事目录名**：从 `$ARGUMENTS` 中提取故事目录名
2. **卷级详细规划**：检查 `$ARGUMENTS` 是否包含 `--detail vol-XX`
   - 如果包含 → 跳转到「2.2.1 卷级详细规划」章节
   - 如果不包含 → 执行正常的全书规划流程

## 执行步骤

### 1. 加载前置文档

**运行脚本** `{SCRIPT}` 检查并加载：
- 宪法文件：`memory/constitution.md`
- 规格文件：`stories/*/specification.md`
- 澄清记录（如果已运行 `/clarify`）

**🆕 解析资源加载报告**：

```bash
# Bash 环境
bash {SCRIPT} --json

# PowerShell 环境
powershell -File {SCRIPT} -Json
```

**报告处理**：
- 检查 `status` 是否为 "ready"
- 记录 `resources` 列表，用于后续规划
- 如果配置了 `resource-loading.knowledge-base.craft`，加载对应资源用于规划参考

**🆕 加载规划辅助资源（基于配置）**：

#### Layer 1: 默认推断

**如果 specification.md 未配置 resource-loading**，或 `auto-load: true`（默认），自动加载：

- `templates/knowledge-base/craft/scene-structure.md`（场景结构）
- `templates/knowledge-base/craft/character-arc.md`（角色弧线）
- `templates/knowledge-base/craft/pacing.md`（节奏控制）
- `templates/skills/planning/story-structure/SKILL.md`（如存在）

#### Layer 2: 配置覆盖

如果 `specification.md` 配置了 `resource-loading.planning`（规划专用配置）：

```yaml
resource-loading:
  planning:  # /plan 命令专用配置
    knowledge-base:
      craft:
        - scene-structure
        - character-arc
    skills:
      planning:
        - story-structure
```

**加载优先级**：
- 规划辅助资源的优先级**低于**宪法和规格
- 规划辅助资源的优先级**高于**类型知识库（genre-knowledge）

---

## 性能优化：会话级资源复用

**优化策略**：
本次对话中已加载的资源知识应复用，避免重复读取文件。

**操作指南**：
1. **首次加载**：读取资源文件内容，记住已加载的资源列表
2. **后续命令**：检查资源是否在"已加载列表"中
   - ✅ 如果已加载：直接使用已有知识，不要重新读取文件
   - ❌ 如果未加载：读取文件并添加到"已加载列表"

**实际场景示例**：
假设本次对话已执行过 `/write chapter-1`，加载了以下资源：
- templates/knowledge-base/craft/dialogue.md
- templates/knowledge-base/craft/scene-structure.md

当用户执行 `/write chapter-2` 时：
- 如需 dialogue 知识 → **直接使用已有知识**，不重新读取文件
- 如需 pacing 知识 → 首次需要，读取文件并添加到已加载列表

**复用判断**：
- 相同文件路径 = 可以复用
- 不同章节、相同资源 = 可以复用
- 用户修改了 specification.md = 重新评估需要哪些资源

**性能收益**：
- 首次命令：正常加载（~50-100ms）
- 重复命令：资源复用（节省 30-50ms）
- 多章节写作：累计节省可观

**注意事项**：
- 如果用户明确要求"重新加载"或"使用最新的"，应重新读取
- 如果发现资源文件内容与记忆不符，应重新读取
- specification.md 的 resource-loading 配置变化时，重新评估资源需求

---

<!-- PLUGIN_HOOK: genre-knowledge-plan -->
<!-- 插件增强区：知识搜索
     如果你安装了 genre-knowledge 插件，请在此处插入知识搜索增强提示词
     参考：plugins/genre-knowledge/README.md 的"2.2 增强 /plan 命令"章节
-->

**🆕 条件加载：黄金开篇法则**：

**判断条件**：
1. 检查 specification.md 中的"目标字数"或"总章数"
2. 检查当前是否在规划开篇阶段
3. 判断依据：
   - 如果总字数 < 10000字，或
   - 如果规划的章节范围包含第1-3章

**如果满足开篇条件，执行以下操作**：

```bash
# 检查是否存在黄金开篇法则文件
test -f spec/presets/golden-opening.md && echo "found" || echo "not-found"
```

- ✅ **如果存在**：读取 `spec/presets/golden-opening.md`
  - 在规划第1-3章时自动应用五大黄金法则
  - 在后续"章节架构设计"部分特别标注前三章规划

- ⚠️ **如果不存在**：继续正常规划（不影响流程）

**🆕 条件加载：节奏配置**：

如果用户使用了 `/book-internalize` 命令分析对标作品：

```bash
# 检查是否存在节奏配置文件
test -f spec/presets/rhythm-config.json && echo "found" || echo "not-found"
```

- ✅ **如果存在**：读取 `spec/presets/rhythm-config.json`
  - 应用对标作品的节奏模式（章节字数、爽点间隔等）
  - 应用内容比例建议（对话/动作/描写/心理）
  - 在"2.2 章节架构设计"中引用这些数据

- ⚠️ **如果不存在**：使用默认节奏规划

**验证规格澄清状态**：
- 如果存在未澄清的关键决策，提示先运行 `/clarify`
- 或接受用户明确指示跳过

### 🆕 Layer 3: 运行时关键词触发

**触发时机**:
- 用户执行 `/plan` 命令时的参数
- 读取 `creative-plan.md` 当前内容时
- 用户在规划过程中的输入

**实现逻辑**: 参考 `/write` 命令的 Layer 3 关键词触发机制

**配置**: 读取 `specification.md` 的 `resource-loading.keyword-triggers`

**扫描文本来源**:
1. 命令参数（如 `/plan 下一章节奏加快`）
2. 现有计划内容（`creative-plan.md`）
3. 用户交互输入

**资源去重**: 跳过 Layer 1/2 已加载的资源

**用户确认**:
```markdown
🔍 **关键词触发检测**

检测到 "节奏加快"，建议加载：
- craft/pacing.md
- writing-techniques/pacing-control

是否加载？ [Y/N/S]
```

**加载流程**: 与 `/write` 相同

**配置示例**:
```yaml
# specification.md
resource-loading:
  keyword-triggers:
    enabled: true  # 默认启用
    custom-mappings:
      节奏: [craft/pacing.md, writing-techniques/pacing-control]
      角色弧线: [craft/character-arc.md, writing-techniques/character-arc]
      场景: [craft/scene-structure.md, writing-techniques/scene-transitions]
```

**注意事项**:
- 关键词检测在 Layer 1/2 完成后执行
- 避免重复加载已有资源
- 用户可选择跳过（S）并记录到 tracking-log.md

### 2. 制定创作计划

创建 `stories/*/creative-plan.md`，包含以下内容：

#### 2.1 写作方法选择

基于规格分析和故事类型，选择最适合的写作方法：
- **三幕结构**：适合线性叙事、明确起承转合
- **英雄之旅**：适合成长型、冒险类故事
- **七点结构**：适合悬念、反转类故事
- **故事圈**：适合角色驱动、心理深度
- **混合方法**：主线+支线使用不同方法
- **类型专用结构**：如爽文的"爽点分布结构"、悬疑的"线索布局结构"等（参考类型知识库）

记录选择理由和应用方式。

#### 2.2 章节架构设计

```markdown
## 章节架构

### 总体规划
- 总章数：[基于目标字数和章节长度]
- 章节长度：[基于节奏配置或默认2000-3000字/章]
- 分卷安排：[如适用]

**🆕 节奏参数（如有rhythm-config.json）**：
- 平均章节字数：[从配置读取，如3200字]
- 小高潮间隔：[从配置读取，如5章]
- 大高潮间隔：[从配置读取，如30章]
- 节奏风格：[快/适中/慢]
- 内容比例：对话[X]% / 动作[X]% / 描写[X]% / 心理[X]%

### 🌟 黄金开篇规划（如果包含第1-3章）

**重要**：如果本次规划包含第1-3章，必须特别注意以下要点（基于 golden-opening.md）：

#### 第一章规划
- ✅ **法则1-动态场景切入**：
  - 禁止：静止场景、大段环境描写
  - 必须：从冲突/动作/对话直接切入
  - 具体设计：[描述第一章的开场方式]

- ✅ **法则2-核心冲突前置**：
  - 第一章内必须抛出主角核心冲突
  - 具体设计：[描述核心冲突如何呈现]

- ✅ **法则3-避免信息轰炸**：
  - 绝对禁止开篇大篇幅介绍世界观
  - 采用"滴灌式"信息透露
  - 具体设计：[列出第一章透露的信息点]

- ✅ **法则4-限制出场人数**：
  - 有名有姓角色不超过3人
  - 具体设计：[列出第一章出场角色]

#### 第二-三章规划
- ✅ **法则5-快速展现金手指**：
  - 第二或第三章内展现"金手指"作用
  - 具体设计：[描述金手指展现方式]

#### 开篇节奏要求
- 第一章目标：钩住读者，建立期待
- 第二章目标：展现能力，强化钩子
- 第三章目标：初步爽点，确认追读

### 情绪曲线设计 ⭐（构建阅读体验的情绪闭环）

**核心理念**：好的小说不仅是故事的旅程，更是**情绪的旅程**。读者追读的本质是追逐情绪的起伏和满足。

**情绪类型定义**（使用小说术语）：

| 情绪类型 | 定义 | 读者体验 | 典型场景 |
|---------|------|---------|---------|
| 😤 **爽点** | 主角获胜、反转、展现实力 | 畅快、解气、期待下一次 | 打脸、逆袭、装逼成功 |
| 😭 **虐点** | 主角失败、压抑、挫折 | 担忧、憋屈、期待翻盘 | 被欺负、失败、失去重要的人 |
| 🤔 **悬念** | 未知、疑问、伏笔 | 好奇、猜测、想继续看 | 出现神秘人物、发现线索、留下谜题 |
| 💧 **平缓** | 日常、过渡、铺垫 | 缓冲、理解、准备情绪 | 日常生活、角色互动、世界观展示 |

**情绪设计原则**：
1. ✅ **欲扬先抑**：爽点前适度铺垫虐点，爽感更强
2. ✅ **张弛有度**：避免连续虐点或连续爽点，保持节奏
3. ✅ **悬念驱动**：每章结尾留悬念，驱动追读欲
4. ✅ **情绪递进**：高潮处的情绪强度要明显高于开篇

**章节段情绪规划**：

| 章节段 | 情绪类型 | 强度 | 目标效果 | 关键场景 |
|--------|---------|------|---------|---------|
| 第1-3章 | 虐→爽→悬念 | 中→高→中 | 开局抑扬，建立追读欲 | [具体描述] |
| 第4-8章 | 平缓→虐→爽 | 低→中→高 | 第一波小高潮 | [具体描述] |
| 第9-15章 | 悬念→虐→爽 | 中→高→高 | 第二波高潮，埋伏笔 | [具体描述] |
| ... | ... | ... | ... | ... |

**情绪强度等级**：
- **低**：情绪波动小，主要是铺垫和过渡
- **中**：情绪有明显起伏，读者有代入感
- **高**：情绪爆发点，读者高度投入
- **极高**：全书顶点，决定性高潮（通常1-3处）

**情绪曲线可视化**（可选，ASCII简图）：
```
情绪强度
极高 |                    ╱╲              ╱╲
高   |         ╱╲        ╱  ╲            ╱  ╲___
中   |    ╱╲  ╱  ╲      ╱    ╲___    ___╱
低   | __╱  ╲╱    ╲____╱         ╲__╱
     └─────────────────────────────────────> 章节
        3   8   15   25   35   45   55
```

**情绪设计自检清单**：
- [ ] 开篇3章是否有明确的情绪钩子？
- [ ] 是否存在连续5章以上的平缓期？（警告：容易弃读）
- [ ] 虐点之后是否有足够的爽点回报？
- [ ] 每个卷/阶段是否有明确的情绪高潮？
- [ ] 全书最高情绪点是否在后1/3部分？
- [ ] 章节结尾是否留有悬念驱动下一章？

**与节奏配置的关系**：
- 如果存在 `rhythm-config.json`，参考其中的"爽点间隔"参数
- 对标作品的情绪节奏可作为参考，但需根据自己的故事调整
- 不同类型有不同的情绪节奏（爽文：高频爽点；悬疑：高频悬念；虐文：后期高爽）

### 结构映射
[根据选定方法，映射关键节点到具体章节]

### 线索分布规划

**重要**：从specification.md第五章读取线索管理规格，在每个卷/章节段标注活跃线索。

#### 第一卷：[卷名](章节范围)

| 章节段 | 内容 | 关键事件 | **活跃线索** | **交汇点** |
|--------|------|---------|-------------|-----------|
| [X-Y章] | [段落内容] | [关键事件列表] | PL-01⭐⭐⭐、PL-02⭐⭐ | X-001(第X章) |
| [X-Y章] | [段落内容] | [关键事件列表] | PL-01⭐⭐、PL-03⭐⭐⭐ | 无 |

**线索标注说明**：
- PL-XX：线索ID，来自specification.md 5.1节
- ⭐⭐⭐ 主推进：本章节段重点推进此线索，占据主要篇幅
- ⭐⭐ 辅助：正常推进，有一定篇幅
- ⭐ 背景：偶尔提及，保持存在感
- X-XXX：交汇点ID，来自specification.md 5.3节

#### 第二卷：[卷名](章节范围)

[重复上述表格结构]

### 节奏设计
- 开篇钩子：第[X]章
- 第一个高潮：第[X]章
- 中点转折：第[X]章
- 最大危机：第[X]章
- 最终高潮：第[X]章
```

#### 2.2.1 卷级详细规划（`--detail vol-XX`）

**触发条件**：`$ARGUMENTS` 包含 `--detail vol-XX`（如 `--detail vol-01`）

**前置条件**：
1. 必须已有 `creative-plan.md`（全书规划），如没有则提示先执行 `/plan`
2. 从 `creative-plan.md` 中读取目标卷的概要信息（卷主题、起止章节、核心冲突）

**卷级规划流程**：

##### Step 1: 卷概要确认

从 `creative-plan.md` 中提取目标卷的信息，向用户确认：

```
📖 卷级详细规划：第 [X] 卷 — [卷名]
━━━━━━━━━━━━━━━━━━━━
📋 卷主题：[从 creative-plan.md 提取]
📊 章节范围：第 [A]-[B] 章（共 [N] 章）
⚡ 核心冲突：[从 creative-plan.md 提取]
🎯 卷目标：[本卷结束时要达到的状态]

确认以上信息正确？如需调整请说明。
```

##### Step 2: 逐章规划

为本卷的每一章生成详细规划：

```markdown
### 第 [N] 章：[章节标题]

**章节定位**：[开篇/发展/转折/高潮/过渡/收束]
**字数预估**：[2000-4000 字]

**本章目标**：
1. [情节目标：推进什么情节线]
2. [角色目标：展示/发展什么角色]
3. [信息目标：释放什么信息给读者]

**场景规划**：
- 场景 1：[地点] — [事件概要]（约 [X] 字）
- 场景 2：[地点] — [事件概要]（约 [X] 字）

**在场角色**：[角色列表]

**爽点设计**：
- [爽点类型]：[具体描述]（强度：⭐⭐⭐）
- 如无爽点：标注「过渡章，无主要爽点」

**钩子设计**：
- 类型：[悬念/反转/信息/情感/时间压力/选择]
- 内容：[钩子具体内容]
- 强度：[⭐-⭐⭐⭐⭐⭐]
- 兑现计划：第 [M] 章

**伏笔操作**：
- 埋设：[新伏笔描述]（预计第 [M] 章回收）
- 推进：[已有伏笔] → [本章推进方式]
- 回收：[已有伏笔] → [本章回收方式]

**情绪节奏**：[高/中/低]
**与上一章的衔接**：[如何承接上一章结尾]
```

##### Step 3: 卷级节奏总览

规划完所有章节后，输出节奏总览：

```
📊 第 [X] 卷节奏总览
━━━━━━━━━━━━━━━━━━━━

情绪曲线：
第 1 章 ████░░░░░░ 中
第 2 章 ██████░░░░ 中高
第 3 章 ████████░░ 高
第 4 章 ███░░░░░░░ 低（过渡）
第 5 章 █████░░░░░ 中
第 6 章 ██████████ 高潮
...

爽点分布：
第 1 章 ⭐⭐ 逆袭
第 3 章 ⭐⭐⭐ 打脸
第 5 章 ⭐⭐⭐⭐ 升级
第 6 章 ⭐⭐⭐⭐⭐ 大反转

钩子链：
第 1 章 → 悬念 ⭐⭐⭐ → 第 2 章兑现
第 2 章 → 信息 ⭐⭐ → 第 3 章兑现
第 3 章 → 反转 ⭐⭐⭐⭐ → 第 5 章兑现（跨章）
...

⚠️ 节奏警告：
- 第 4-5 章连续中低节奏，考虑在第 4 章末尾加强钩子
- 第 6 章高潮后建议第 7 章适当放缓
```

##### Step 4: 写入 creative-plan.md

将卷级详细规划追加到 `creative-plan.md` 的对应卷章节中，或创建独立的 `vol-XX-detail.md` 文件。

**写入策略**：
- 如果 `creative-plan.md` 中已有该卷的详细规划 → 询问是否覆盖
- 如果 `creative-plan.md` 过长（> 500 行）→ 创建 `stories/*/spec/vol-XX-detail.md`
- 否则 → 追加到 `creative-plan.md` 的对应位置

##### Step 5: 生成 tasks.md 条目

基于卷级规划，自动生成 `tasks.md` 中的写作任务：

```markdown
## 第 [X] 卷写作任务

- [ ] 第 [A] 章：[章节标题] — [一句话目标]
- [ ] 第 [A+1] 章：[章节标题] — [一句话目标]
...
- [ ] 第 [B] 章：[章节标题] — [一句话目标]
```

---

#### 2.2.2 爽点分布规划

**执行时机**：全书规划时（非 `--detail` 模式）

**前置加载**：
- 如果 `specification.md` 中的类型为网文类（玄幻、都市、言情等）→ 加载对应类型知识库
- 读取 `rhythm-config.json`（如存在）获取节奏参数

**规划步骤**：

##### Step 1: 确定爽点类型池

根据故事类型，确定可用的爽点类型：

| 故事类型 | 主要爽点类型 | 次要爽点类型 |
|---------|------------|------------|
| 玄幻/修仙 | 升级、打脸、获得 | 逆袭、揭秘、认可 |
| 都市 | 打脸、逆袭、认可 | 获得、揭秘 |
| 言情 | 情感满足、误会解除、认可 | 逆袭、揭秘 |
| 悬疑 | 揭秘、反转 | 逆袭、认可 |
| 文学 | 顿悟、和解、成长 | 揭秘 |

##### Step 2: 规划爽点密度

根据目标读者和类型，设定爽点密度目标：

```
📊 爽点密度规划
━━━━━━━━━━━━━━━━━━━━
故事类型：[类型]
目标密度：[X] 个爽点/卷

分布原则：
- 每卷开头 3 章内必须有 1 个爽点（留住读者）
- 每卷高潮必须有 1 个强爽点（⭐⭐⭐⭐ 以上）
- 连续无爽点章节不超过 [N] 章（网文 ≤ 3，文学 ≤ 5）
- 爽点类型至少 3 种（避免单调）
```

##### Step 3: 生成爽点分布表

在 `creative-plan.md` 中记录：

```markdown
## 爽点分布规划

### 全书爽点曲线

| 卷 | 章节范围 | 爽点数 | 主要爽点 | 高潮爽点 |
|----|---------|--------|---------|---------|
| 第 1 卷 | 1-30 | 8 | 打脸×3, 升级×3, 获得×2 | 第 28 章：大反转 |
| 第 2 卷 | 31-60 | 10 | 打脸×2, 升级×4, 逆袭×2, 揭秘×2 | 第 58 章：身世揭秘 |
| ... | ... | ... | ... | ... |

### 爽点递进设计

- 第 1 卷爽点强度：⭐⭐-⭐⭐⭐（建立基线）
- 第 2 卷爽点强度：⭐⭐⭐-⭐⭐⭐⭐（升级）
- 第 3 卷爽点强度：⭐⭐⭐⭐-⭐⭐⭐⭐⭐（高潮）
- ...

原则：后续卷的爽点强度应 ≥ 前卷，避免「越写越无聊」
```

#### 2.2.3 钩子链设计

**执行时机**：全书规划时（非 `--detail` 模式）

**前置加载**：
- 加载知识库：`templates/knowledge-base/craft/hook-design.md`（如存在）

**规划步骤**：

##### Step 1: 确定关键钩子节点

在全书结构中标记必须有强钩子的位置：

```
🪝 关键钩子节点
━━━━━━━━━━━━━━━━━━━━

必须有强钩子（⭐⭐⭐⭐ 以上）的位置：
- 第 1 章结尾（决定读者是否继续）
- 每卷最后一章（决定读者是否追下一卷）
- 重大转折前一章（制造期待）
- 免费章节最后一章（付费转化关键点，如适用）

建议有中等钩子（⭐⭐⭐）的位置：
- 每个小高潮前一章
- 视角切换章节
- 新角色/新势力登场前
```

##### Step 2: 规划卷间钩子链

```markdown
## 钩子链规划

### 卷间钩子（最重要）

| 卷末章节 | 钩子类型 | 强度 | 内容概要 | 下卷开头如何兑现 |
|---------|---------|------|---------|---------------|
| 第 30 章（卷 1 末） | 反转 | ⭐⭐⭐⭐⭐ | [描述] | 第 31 章开头揭示 |
| 第 60 章（卷 2 末） | 悬念 | ⭐⭐⭐⭐ | [描述] | 第 61 章开头回应 |
| ... | ... | ... | ... | ... |

### 主线钩子链

[描述贯穿全书的主要悬念线如何通过钩子链推进]

1. 第 [N] 章：埋设主线悬念 →
2. 第 [M] 章：提供部分线索 →
3. 第 [K] 章：误导性揭示 →
4. 第 [L] 章：真相大白
```

##### Step 3: 写入 creative-plan.md

将爽点分布和钩子链规划写入 `creative-plan.md` 的对应章节。

---

#### 2.3 人物体系设计

```markdown
## 人物体系

### 主角设计
- 初始状态：[起点]
- 成长弧线：[变化轨迹]
- 核心冲突：[内在vs外在]
- 关键转变点：[具体章节]

### 配角功能
[每个重要配角的功能定位和出场计划]

### 关系网络
[人物关系图和演变计划]
```

#### 2.4 世界观构建

```markdown
## 世界观体系

### 核心设定
- 世界规则：[物理/魔法/科技规则]
- 社会结构：[政治/经济/文化]
- 历史背景：[重要历史事件]

### 设定展开计划
- 第一层（开篇）：[基础设定]
- 第二层（发展）：[深入设定]
- 第三层（高潮）：[核心秘密]
```

#### 2.5 情节技术设计

```markdown
## 情节技术

### 冲突升级路径
1. 初级冲突：[个人层面]
2. 中级冲突：[团体层面]
3. 高级冲突：[世界层面]

### 悬念设置
- 主悬念：[贯穿全文]
- 章节悬念：[每章钩子]
- 支线悬念：[丰富层次]

### 伏笔布局
[伏笔清单和回收计划]
```

#### 2.6 叙事技术选择

```markdown
## 叙事技术

### POV设计
- 视角类型：[第一/第三人称]
- 视角限制：[全知/限定]
- 多视角安排：[如适用]

### 时间线设计
- 主线时间：[线性/非线性]
- 回忆穿插：[使用策略]
- 平行叙事：[如适用]

### 叙事节奏
- 快节奏段落：[动作/冲突]
- 慢节奏段落：[情感/描写]
- 节奏变化：[张弛规律]
```

### 3. 技术决策记录

记录所有重要的技术决策：
- **决策**：选择了什么
- **理由**：为什么选择
- **风险**：可能的问题
- **备案**：替代方案

### 4. 质量保证计划

```markdown
## 质量保证

### 自检清单
- [ ] 逻辑一致性检查点
- [ ] 人物行为合理性
- [ ] 世界观自洽性
- [ ] 节奏流畅性

### 验证节点
- 每5章：小循环验证
- 每卷：大循环验证
- 完稿：全面验证
```

### 5. 风险管理

识别并制定应对策略：
- **创作风险**：灵感、逻辑、节奏
- **技术风险**：复杂度、一致性
- **时间风险**：进度、质量平衡

### 6. 输出和验证

- 保存计划到 `stories/*/creative-plan.md`
- 验证计划符合宪法原则
- 验证计划满足规格需求
- 提示下一步：运行 `/tasks` 生成任务

## 与其他命令的关系

- **输入**：来自 `/specify` 的规格 + `/clarify` 的澄清
- **输出**：为 `/tasks` 提供任务生成依据
- **验证**：被 `/analyze` 用于检查实现符合度
- **期待管理**：规划章节时参考 `reader-expectation` Skill，在大纲阶段识别期待并安排满足时间点，确保每个情节承诺、谜题悬念都有明确的 payoff 章节
- **多线叙事**：多POV或多线结构时参考 `multi-thread-narrative` Skill，在大纲阶段设计线程分配、交织模式和汇聚点，确保线程平衡

## 注意事项

### 🌟 黄金开篇法则的应用（重要）

**何时应用**：
- 规划包含第1-3章时自动触发
- 或总字数 < 10000字的短篇作品

**为什么重要**：
- 前三章决定了80%的读者留存率
- 开篇是读者决定是否追读的关键窗口
- 黄金开篇法则经过大量爆款作品验证

**如何应用**：
1. 在"章节架构设计"中创建独立的"黄金开篇规划"部分
2. 逐条检查五大法则是否在前三章中体现
3. 具体设计每一章如何满足法则要求
4. 如果规格与法则冲突，优先遵循法则（或有意识地违反）

**常见误区**：
- ❌ 第一章大段描写世界观设定
- ❌ 主角在第一章只是日常生活，没有冲突
- ❌ 第一章出场角色过多（>3人）
- ❌ 金手指/核心能力延迟到第五章以后才展现

### 🎵 节奏配置的应用

**如果使用了 `/book-internalize`**：
- 系统会自动读取 `spec/presets/rhythm-config.json`
- 应用对标作品的节奏参数（章节字数、爽点间隔等）
- 应用内容比例（对话/动作/描写/心理）

**参数优先级**：
1. **用户即时指令**（最高）
2. **rhythm-config.json**（对标作品节奏）
3. **类型知识库**（类型通用节奏）
4. **默认值**（2000-3000字/章）

**建议**：
- 对标作品的节奏参数仅供参考
- 根据自己的创作习惯适度调整
- 不要生搬硬套，保持灵活性

### 技术服务于故事
- 所有技术选择都要服务于故事表达
- 不要为了技巧而技巧
- 保持方案的灵活性

### 可执行性
- 计划要具体可执行
- 避免过于理想化
- 考虑实际创作能力

### 迭代优化
- 计划可以根据实践调整
- 记录调整原因和影响
- 保持版本追踪

记住：**好的计划是成功的一半，但要随时准备调整。黄金开篇是硬规则，其他规划可以灵活。**

---

## 🆕 后置处理：plot-tracker 自动更新

**执行时机**: 创作计划完成后，`creative-plan.md` 已写入

**更新策略**: 核心命令（/plan）自动更新，无需用户确认

### 自动更新 plot-tracker.json

#### 更新内容

**基于 creative-plan.md 提取**:
1. **情节线定义**
   - 主线情节
   - 支线情节
   - 情节线之间的关系

2. **章节情节分配**
   - 每个章节对应的情节线
   - 情节推进目标
   - 关键转折点

3. **伏笔规划**
   - 计划埋设的伏笔
   - 伏笔回收章节
   - 伏笔重要性

**示例更新**:
```json
{
  "plotLines": [
    {
      "id": "主线-001",
      "name": "寻找真相",
      "type": "main",
      "description": "主角追寻失踪案真相的过程",
      "startChapter": "chapter-01",
      "endChapter": "chapter-20",
      "status": "planned",
      "progress": 0,
      "milestones": [
        {
          "chapter": "chapter-03",
          "description": "发现第一条线索",
          "importance": "high",
          "status": "planned"
        },
        {
          "chapter": "chapter-10",
          "description": "重大转折:发现内幕",
          "importance": "critical",
          "status": "planned"
        }
      ],
      "events": []
    },
    {
      "id": "支线-001",
      "name": "情感发展",
      "type": "subplot",
      "description": "主角与女主的感情线",
      "relatedTo": ["主线-001"],
      "startChapter": "chapter-02",
      "endChapter": "chapter-18",
      "status": "planned",
      "progress": 0,
      "events": []
    }
  ],
  "foreshadowing": [
    {
      "chapter": "chapter-02",
      "content": "神秘人物首次出现",
      "payoffChapter": "chapter-15",
      "status": "planned",
      "importance": "high"
    }
  ],
  "meta": {
    "lastUpdate": "2026-02-08",
    "plannedBy": "/plan",
    "totalPlotLines": 5,
    "completedPlotLines": 0
  }
}
```

#### 更新执行流程

**Step 1: 解析 creative-plan.md**

```markdown
从刚创建的 `creative-plan.md` 中提取：
1. 章节架构（第 2.2 节）
2. 情节线设计（第 2.3 节）
3. 关键场景规划（第 2.4 节）
4. 伏笔设置（如有明确规划）
```

**Step 2: 生成 plot-tracker 初始化内容**

```markdown
基于提取的信息，生成 plot-tracker.json 的初始结构：
- 所有情节线的定义
- 每个情节线的里程碑（milestones）
- 计划的伏笔列表
- 元信息（meta）
```

**Step 3: 自动应用更新**

```markdown
**无需用户确认**，直接更新文件：
1. 检查 `spec/tracking/plot-tracker.json` 是否存在
2. 如果不存在，创建新文件并写入内容
3. 如果存在，合并新的情节线定义（保留已有的 progress 信息）
4. 验证 JSON 格式有效性
```

**Step 4: 记录到 tracking-log.md**

追加更新记录到 `stories/*/spec/tracking/tracking-log.md`：

**日志格式示例**:

```
## [时间戳] - /plan 创作计划

### 命令执行
- **命令**: `/plan`
- **故事**: [故事名称]
- **总章数**: XX 章
- **执行者**: AI
- **状态**: 已自动更新

### 自动更新内容

#### plot-tracker.json

使用 diff 格式展示更新（示例）:

+ {
+   "plotLines": [
+     {
+       "id": "主线-001",
+       "name": "寻找真相",
+       "type": "main",
+       "startChapter": "chapter-01",
+       "endChapter": "chapter-20",
+       "milestones": [...]
+     },
+     {
+       "id": "支线-001",
+       "name": "情感发展",
+       "type": "subplot",
+       "relatedTo": ["主线-001"]
+     }
+   ],
+   "foreshadowing": [
+     {
+       "chapter": "chapter-02",
+       "content": "神秘人物首次出现",
+       "payoffChapter": "chapter-15"
+     }
+   ]
+ }

### 更新依据
- **情节线提取**: 从 creative-plan.md 第 2.3 节提取 5 条情节线定义
- **里程碑提取**: 从章节架构中识别关键转折点
- **伏笔规划**: 从关键场景规划中提取预设伏笔
- **关联关系**: 分析情节线之间的依赖和交织关系

---
```

#### 错误处理

**如果 creative-plan.md 格式不完整**:
```markdown
⚠️ 警告：创作计划格式不完整
- 缺少章节：[缺少的章节名称]
- 建议：补充完整后再运行 `/plan`
- 创建基础的 plot-tracker.json（仅包含元信息）
```

**如果 plot-tracker.json 已存在且有进度数据**:
```markdown
⚠️ 警告：plot-tracker.json 已存在
- 现有情节线：[列出已有的情节线]
- 现有进度数据：[显示 progress > 0 的情节线]
- 操作：合并新情节线，保留现有进度
- 建议：检查是否需要手动调整
```

#### 向后兼容

如果项目没有 `spec/tracking/` 目录：
```markdown
ℹ️ 提示：tracking 目录不存在
- 建议：运行 `/track --init` 初始化 tracking 系统
- 或创建 spec/tracking/ 目录
- 跳过本次更新
```
