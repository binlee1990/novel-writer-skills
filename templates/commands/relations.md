---
name: relations
description: 管理和追踪角色关系变化
argument-hint: [update | show | history | check] [角色] [关系] [目标角色]
allowed-tools: Read(//spec/tracking/relationships.json), Read(//spec/tracking/relationships.json), Write(//spec/tracking/relationships.json), Write(//spec/tracking/relationships.json), Bash(find:*), Bash(*)
scripts:
  sh: .specify/scripts/bash/manage-relations.sh
  ps: .specify/scripts/powershell/manage-relations.ps1
---

# 角色关系管理

追踪和管理角色之间的关系动态，确保关系发展的合理性。

## 资源加载（可选）

本命令用于管理角色关系，默认读取 `tracking/relationships.json`。

### 可选配置

```yaml
resource-loading:
  relations:
    knowledge-base:
      craft:
        - character-arc  # 角色弧线知识
    skills:
      quality-assurance:
        - consistency-checker  # 关系一致性检查
```

**推荐资源**: character-arc.md（理解关系演变）

## 功能

1. **关系网络** - 维护角色之间的关系图谱
2. **关系变化** - 记录关系的演变历程
3. **派系管理** - 追踪各势力派系的对立与合作
4. **情感追踪** - 管理角色间的情感发展

## 使用方法

执行脚本 {SCRIPT} [操作] [参数]：
- `update` - 更新角色关系
- `show` - 显示关系网络
- `history` - 查看关系变化历史
- `check` - 验证关系逻辑

示例：
```
{SCRIPT} update 李中庸 allies 沈玉卿 --chapter 61 --note 初入翰林相助
# PowerShell:
{SCRIPT} -Command update -A 李中庸 -Relation allies -B 沈玉卿 -Chapter 61 -Note 初入翰林相助
```

## 数据存储

关系数据存储在 `spec/tracking/relationships.json`：
```json
{
  "characters": {
    "主角": {
      "盟友": ["角色A", "角色B"],
      "敌对": ["角色C"],
      "爱慕": ["角色D"],
      "未知": ["角色E"]
    }
  },
  "factions": {
    "改革派": ["主角", "角色A"],
    "保守派": ["角色C", "角色F"]
  }
}
```

## 输出示例

```
👥 角色关系网络
━━━━━━━━━━━━━━━━━━━━
主角：李中庸
├─ 💕 爱慕：沈玉卿
├─ 🤝 盟友：张居正（隐藏）
├─ 📚 导师：利玛窦
├─ ⚔️ 敌对：申时行派系
└─ 👁️ 监视：东厂

派系对立：
改革派 ←→ 保守派
东林党 ←→ 阉党

最近变化（第60章）：
- 沈玉卿：陌生人 → 相互吸引
- 张居正：未知 → 师承关系
```

---

## 增强功能

### 关系图谱可视化

#### 全局关系图

```
👥 角色关系图谱
━━━━━━━━━━━━━━━━━━━━

                    [师父]
                   ╱      ╲
              师徒/         \师徒
                ╱             ╲
          [主角] ←── 暗恋 ── [师姐]
            │ ╲               │
          仇敌  同门           │
            │    ╲           同门
            ↓     ╲           │
         [反派]    [师弟] ── [师妹]
            │                  │
          主从                朋友
            │                  │
         [手下A]           [城主之女]
```

#### 关系列表视图

```
👥 关系详情
━━━━━━━━━━━━━━━━━━━━

[主角] 的关系：
  ├─ [师父]    ：师徒 ★★★★★ （尊敬、信任）
  ├─ [师姐]    ：同门 ★★★★☆ （好感、暗恋）→ 变化中
  ├─ [师弟]    ：同门 ★★★☆☆ （友好、竞争）
  ├─ [反派]    ：仇敌 ★★★★★ （仇恨、警惕）
  └─ [城主之女]：朋友 ★★☆☆☆ （初识、好奇）

关系强度说明：★ = 关系深度/重要性（1-5）
```

#### 阵营视图

```
👥 阵营关系
━━━━━━━━━━━━━━━━━━━━

🟢 主角阵营：
  [主角]、[师父]、[师姐]、[师弟]、[城主之女]

🔴 反派阵营：
  [反派]、[手下A]、[手下B]

🟡 中立/未定：
  [神秘人]、[商人]

阵营关系：
  主角阵营 ←→ 反派阵营：敌对
  主角阵营 ←→ 中立：友好（但[神秘人]立场不明）
```

### 关系变化追踪

#### 关系演变时间线

```
📈 关系演变 — [主角] ↔ [师姐]
━━━━━━━━━━━━━━━━━━━━

第 1 章  ：初识（陌生）     ★☆☆☆☆
第 3 章  ：指导修炼（好感） ★★☆☆☆  ↑
第 8 章  ：并肩战斗（信任） ★★★☆☆  ↑
第 12 章 ：误会（疏远）     ★★☆☆☆  ↓
第 15 章 ：误会解除（亲近） ★★★★☆  ↑↑
第 20 章 ：生死相依（深厚） ★★★★★  ↑

趋势：稳步上升（中间有一次波折，符合「先抑后扬」模式）
```

#### 关系变化汇总

```
📊 最近 5 章关系变化
━━━━━━━━━━━━━━━━━━━━

| 关系 | 变化前 | 变化后 | 触发事件 | 章节 |
|------|--------|--------|---------|------|
| 主角↔师姐 | ★★★☆ | ★★★★ | 并肩战斗 | 第 18 章 |
| 主角↔反派 | ★★★★ | ★★★★★ | 反派伤害师姐 | 第 19 章 |
| 师弟↔师妹 | ★★☆☆ | ★★★☆ | 共同修炼 | 第 20 章 |

⚠️ 长期未变化的关系：
- 主角↔城主之女：已 10 章未有互动，关系停滞
  → 建议：安排互动场景，或确认此关系是否需要发展
```

### 关系冲突检测

检测关系描写中的不一致：

| 冲突类型 | 描述 |
|---------|------|
| 态度矛盾 | 设定为仇敌，但对话中表现友好 |
| 称呼不一致 | 同一关系在不同章节使用不同称呼 |
| 关系跳跃 | 关系突然变化，缺少过渡 |
| 单向矛盾 | A 对 B 的态度与 B 对 A 的态度不匹配（非刻意设计时） |

#### 冲突报告

```
⚠️ 关系冲突检测
━━━━━━━━━━━━━━━━━━━━

🔴 严重冲突：
1. 关系跳跃：主角↔师弟
   第 10 章：关系紧张（争吵）
   第 11 章：亲密无间（称兄道弟）
   → 缺少和解过渡，建议补充

⚠️ 轻微冲突：
2. 称呼不一致：主角对师姐
   第 5 章：「师姐」
   第 12 章：「小雪」（未交代何时改口）
   → 建议在某章节自然过渡称呼变化
```

---


## 🔗 命令链式提示

**命令执行完成后，自动附加下一步建议**：

```
💡 下一步建议：
1️⃣ `/write [章节号]` — 基于更新后的关系网络继续写作
2️⃣ `/character show [角色名]` — 查看角色完整档案和关系详情
3️⃣ `/track --check` — 验证关系数据与章节内容的一致性
```
