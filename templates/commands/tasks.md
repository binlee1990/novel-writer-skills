---
description: 将创作计划分解为可执行的任务清单
allowed-tools: Read(//stories/**/creative-plan.md), Read(//stories/**/creative-plan.md), Read(//stories/**/specification.md), Read(//stories/**/specification.md), Write(//stories/**/tasks.md), Write(//stories/**/tasks.md), Bash(find:*), Bash(*)
scripts:
  sh: .specify/scripts/bash/tasks-story.sh
  ps: .specify/scripts/powershell/generate-tasks.ps1
---

基于创作计划生成具体的、可执行的任务列表。

## 资源加载（可选）

本命令用于管理创作任务，默认不加载额外资源。

### 可选配置

如果需要在任务规划时参考写作技巧：

```yaml
resource-loading:
  tasks:
    knowledge-base:
      craft:
        - scene-structure  # 场景结构规划
        - pacing  # 节奏规划
```

**推荐资源**: scene-structure.md, pacing.md（辅助任务规划）

## 目标

将宏观计划转化为微观任务，让创作变得可管理、可追踪。

## 执行步骤

### 1. 加载计划文档

运行 `{SCRIPT}` 加载：
- 创作计划：`stories/*/creative-plan.md`
- 章节架构信息
- 时间线和依赖关系

### 2. 生成任务列表

创建 `stories/*/tasks.md`，包含：

#### 核心写作任务

**重要**：从specification.md第五章和creative-plan.md的线索分布，为每个写作任务标注涉及线索。

```markdown
## 写作任务

### 高优先级 [必须首先完成]

- [ ] [P0] **T001** - 第1章：[章节标题] (目标字数)
  - **核心任务**：[本章的主要任务]
  - **关键情节**：[具体情节点]
  - **涉及线索**：
    - PL-XX([线索名称]) ⭐⭐⭐ 主推进
    - PL-YY([线索名称]) ⭐ 背景
  - **交汇点**：[如适用] X-001([交汇点描述])
  - **伏笔埋设/揭晓**：[如适用] F-001埋设 / F-002揭晓
  - **必须包含**：[关键元素列表]
  - **章末钩子**：[悬念设置]
  - **依赖**：无
  - **输出**：`content/volume1/chapter-001.md`

- [ ] [P0] **T002** - 角色档案：主角详细设定
  - **核心任务**：完善主角设定
  - **必须包含**：性格、背景、能力、欲望、恐惧、成长弧线
  - **依赖**：无
  - **输出**：`characters/protagonist.md`

### 中优先级 [正常推进]

- [ ] [P1] **T005** - 第5章：[章节标题] (目标字数)
  - **核心任务**：[本章主要任务]
  - **关键情节**：[具体情节]
  - **涉及线索**：
    - PL-01([线索名]) ⭐⭐⭐ 主推进
    - PL-02([线索名]) ⭐⭐ 辅助
  - **交汇点**：无
  - **伏笔埋设/揭晓**：F-001埋设([伏笔内容])
  - **必须包含**：[关键元素]
  - **章末钩子**：[悬念]
  - **依赖**：T004(第4章)
  - **输出**：`content/volume1/chapter-005.md`

### 低优先级 [可选完善]

- [ ] [P2] 番外：角色前传
- [ ] [P2] 设定集：详细世界观
```

**任务字段说明**：
- **涉及线索**：从creative-plan.md的"活跃线索"列读取，标明本章推进哪些线索
- **交汇点**：从specification.md 5.3节读取，标明本章是否为交汇点
- **伏笔埋设/揭晓**：从specification.md 5.4节读取，标明本章涉及的伏笔操作

#### 任务标记说明
- `[P]` - 可并行执行
- `[依赖:X]` - 需要先完成任务X
- `[P0/P1/P2]` - 优先级标记

### 3. 任务排序和分组

- 按优先级分组
- 识别依赖关系
- 标记可并行任务
- 估算完成时间

### 4. 生成执行计划

```markdown
## 执行计划

### 第一阶段（第1周）
并行任务组1：
- 主角设定 [P]
- 世界观基础 [P]
- 第1章草稿 [P]

### 第二阶段（第2-3周）
串行任务：
- 第2章 [依赖:第1章]
- 第3章 [依赖:第2章]

并行任务组2：
- 配角设定 [P]
- 场景设计 [P]
```

### 5. 输出任务统计

- 总任务数
- 预计总字数
- 预计完成时间
- 关键里程碑

提示下一步：开始执行 `/write` 或查看特定任务详情。

---

## 增强功能

### 任务优先级

每个任务可设置优先级，用于排序和筛选：

| 优先级 | 标记 | 含义 |
|--------|------|------|
| P0 | 🔴 | 紧急：阻塞写作进度 |
| P1 | 🟠 | 重要：影响质量但不阻塞 |
| P2 | 🟡 | 普通：常规写作任务 |
| P3 | 🟢 | 低优：优化/润色类 |

#### 优先级排序视图

**触发条件**：`$ARGUMENTS` 包含 `--by-priority`

```
📋 任务列表（按优先级）
━━━━━━━━━━━━━━━━━━━━

🔴 P0 紧急：
  □ 回收「身世之谜」伏笔（已延迟 5 章）
  □ 修复第 18 章时间线冲突

🟠 P1 重要：
  □ 写第 26 章（主线推进）
  □ 安排师姐出场（已缺席 7 章）

🟡 P2 普通：
  □ 写第 27 章
  □ 补充城主之女的背景设定

🟢 P3 低优：
  ☑ 润色第 20 章对话
  □ 更新角色关系图
```

### 任务依赖关系

任务之间可以设置依赖关系，支持显式依赖和自动检测：

#### 依赖关系图

```
📋 任务依赖图
━━━━━━━━━━━━━━━━━━━━

[完善力量体系设定] ──→ [写第 26 章战斗场景]
                          │
                          ↓
                    [写第 27 章战后处理] ──→ [写第 28 章新篇章]

[安排师姐出场] ──→ [写第 26 章]（师姐在此章出场）

⚠️ 阻塞任务：
- 「完善力量体系设定」阻塞了 3 个下游任务
  → 建议优先处理
```

#### 自动依赖检测

自动检测以下隐含依赖：

| 依赖类型 | 检测规则 |
|---------|---------|
| 章节顺序 | 第 N+1 章自动依赖第 N 章 |
| 设定依赖 | 引用某设定的写作任务依赖该设定的完善任务 |
| 伏笔依赖 | 伏笔回收任务依赖伏笔埋设任务 |
| 角色依赖 | 角色出场任务依赖角色设定完善任务 |

### 从计划自动生成任务

**触发条件**：`$ARGUMENTS` 包含 `--from-plan`

**执行流程**：
1. 读取 `creative-plan.md`
2. 提取每章的计划内容
3. 为每章生成一个写作任务
4. 自动设置依赖关系（顺序依赖）
5. 按三层 Fallback 读取 tracking 数据生成修复/维护任务：
   - **MCP 查询（优先）**：`query_plot --status=overdue` 获取延迟伏笔，`stats_volume` 获取进度
   - **分片 JSON（次优）**：读取 `spec/tracking/summary/plot-summary.json` 获取未解决伏笔
   - **单文件 JSON（兜底）**：读取 `spec/tracking/plot-tracker.json`
6. 从 `/analyze` 反馈中提取修复任务
7. 从 `/track --check` 中提取维护任务

#### 生成规则

| 来源 | 生成的任务类型 | 优先级 |
|------|--------------|--------|
| 章节计划 | 写作任务 | P2 |
| 伏笔回收计划 | 伏笔任务 | 根据紧急度 P0-P2 |
| 角色出场计划 | 角色任务 | P1-P2 |
| 分析反馈 | 修复任务 | P0-P1 |
| tracking 落后 | 维护任务 | P1 |

#### 输出示例

```
📋 从计划生成任务
━━━━━━━━━━━━━━━━━━━━

已生成 8 个任务：

🟡 P2 写作任务（5 个）：
  □ 写第 26 章：师姐出场 + 主角突破
  □ 写第 27 章：新敌人登场
  □ 写第 28 章：情报收集
  □ 写第 29 章：潜入敌营
  □ 写第 30 章：卷末高潮

🟠 P1 伏笔任务（2 个）：
  □ 在第 26 章回收「身世之谜」伏笔
  □ 在第 28 章埋设「远古秘密」伏笔

🔴 P0 修复任务（1 个）：
  □ 修复第 18 章时间线冲突

是否确认生成？[Y/N]
```

### 任务完成度统计

**触发条件**：`$ARGUMENTS` 包含 `--stats`

```
📊 任务统计
━━━━━━━━━━━━━━━━━━━━

总任务：[N] 个
  ✅ 已完成：[A] 个（[X]%）
  🔄 进行中：[B] 个
  ⏳ 待办  ：[C] 个
  ❌ 已取消：[D] 个

按优先级：
  🔴 P0：[完成]/[总数]
  🟠 P1：[完成]/[总数]
  🟡 P2：[完成]/[总数]
  🟢 P3：[完成]/[总数]

按类型：
  写作任务：[完成]/[总数]
  修复任务：[完成]/[总数]
  维护任务：[完成]/[总数]

进度条：▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░ [X]%
```

---


## 🔗 命令链式提示

**命令执行完成后，自动附加下一步建议**：

```
💡 下一步建议：
1️⃣ `/write [章节号]` — 开始执行第一个写作任务
2️⃣ `/analyze --type=framework` — 写作前验证框架一致性
3️⃣ `/track-init` — 初始化追踪系统（如尚未初始化）
```
