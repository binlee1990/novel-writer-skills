---
name: recap
description: 自动重建创作上下文，汇总角色状态、未解决伏笔、情节进展和关系网络，生成结构化简报
argument-hint: [--brief]
allowed-tools: Read(//**), Bash(find:*), Bash(wc:*), Bash(grep:*), Bash(*)
---

# /recap - 上下文重建命令

在隔天/隔周续写前，或写到 30+ 章后感觉失焦时，使用本命令快速重建完整的创作上下文。

**核心价值**：让作者在 5 分钟内从"完全忘记"到"胸有成竹"。

---

## 使用场景

### 场景 1：隔天续写
```
用户："昨天写到 28 章，今天继续写 29 章，先回顾一下"
→ 执行 /recap，输出完整上下文简报
→ 快速扫描后开始 /write
```

### 场景 2：长篇失焦诊断
```
用户："写到 35 章了，感觉有点乱"
→ 执行 /recap，发现 3 个超期伏笔、2 个角色长期未出现
→ 基于简报调整后续写作计划
```

### 场景 3：计划调整
```
用户："我想调整后面的情节，先看看现在的状态"
→ 执行 /recap，展示全局视图
→ 基于简报讨论调整方案
```

---

## 执行流程

### 阶段 1: 数据采集

**读取以下文件（按优先级排序）**：

#### 第一优先级：追踪数据（核心数据源）

1. `spec/tracking/character-state.json` - 角色当前状态
2. `spec/tracking/plot-tracker.json` - 情节追踪（含伏笔）
3. `spec/tracking/relationships.json` - 关系网络
4. `spec/tracking/timeline.json` - 时间线

#### 第二优先级：创作基础文件

5. `stories/[current]/specification.md` - 故事规格
6. `stories/[current]/creative-plan.md` - 创作计划
7. `stories/[current]/tasks.md` - 任务清单

#### 第三优先级：最近内容

8. 最近 3 章的章节文件（`stories/[current]/content/chapter-XX.md`）
   - 按文件名倒序排列，取最近 3 个

#### 第四优先级：辅助文件（可选）

9. `.specify/memory/constitution.md` - 创作宪法
10. `spec/tracking/validation-rules.json` - 验证规则

**数据缺失处理**：

| 文件 | 缺失时的行为 |
|------|------------|
| character-state.json | 警告，从最近章节推断角色状态 |
| plot-tracker.json | 警告，简报中省略伏笔部分 |
| relationships.json | 警告，简报中省略关系网络 |
| timeline.json | 警告，简报中省略时间线 |
| specification.md | 报错，建议先执行 /specify |
| creative-plan.md | 警告，简报中省略计划信息 |
| tasks.md | 警告，简报中省略任务状态 |
| 章节文件 | 报错，尚无可回顾的内容 |

**如果所有追踪文件都不存在**：
```
⚠️ 追踪数据缺失

未找到任何追踪文件（spec/tracking/）。
本简报将基于现有章节内容和规格文件生成简化版。

建议：
1. 执行 /track-init 初始化追踪系统
2. 执行 /track 更新追踪数据
3. 然后重新执行 /recap 获取完整简报
```

---

### 阶段 2: 智能汇总

按以下结构生成上下文简报。

**参数处理**：
- 无参数：生成完整的 8 部分简报
- `--brief`：仅生成"快速参考卡片"（第 8 部分）

---

## 上下文简报模板

### 简报头部

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 上下文简报
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

生成日期：[当前日期]
故事名称：[从 specification.md 提取]
当前进度：第 [N] 章 / 预计 [M] 章
数据来源：[列出实际读取的追踪文件]
```

---

### 第 1 部分：角色当前状态

**数据来源**：`character-state.json` > 最近章节内容

```markdown
### 1. 角色当前状态 🎭

**主角**

**[角色名]** (主角)
- **位置**：[当前所在地]（第 [N] 章）
- **状态**：[物理/情感状态]
- **目标**：[当前追求的目标]
- **弧线阶段**：[当前发展阶段]
- **最近变化**：[最后一次重要变化，章节号]

**重要配角**（按重要性排序）

**[角色名]** ([角色功能])
- **状态**：[一句话概括]
- **最后出场**：第 [N] 章

**次要角色快速参考**：
- 角色 A：[一句话状态]
- 角色 B：[一句话状态]
```

**角色状态警告算法**：

从 `character-state.json` 的 `appearanceTracking` 和 `characterGroups` 中检测：

```
对于每个重要角色（importance = "high" 或 "medium"）：
  chapters_since_appearance = 当前章节 - 最后出场章节

  如果 importance == "high" 且 chapters_since_appearance > 10：
    ⚠️ "[角色名] 已 [N] 章未出场（重要角色）"

  如果 importance == "medium" 且 chapters_since_appearance > 15：
    ⚠️ "[角色名] 已 [N] 章未出场"
```

将所有警告在该部分末尾集中展示：

```markdown
**⚠️ 角色状态警告**：
- [角色名] 已 [N] 章未出场（重要角色，建议尽快安排出场）
- [角色名] 已 [N] 章未出场
```

---

### 第 2 部分：主线情节进展

**数据来源**：`plot-tracker.json` > `creative-plan.md`

```markdown
### 2. 主线情节进展 📖

**故事当前位置**（三幕/多卷结构）

[从 specification.md 提取结构信息，生成进度条]
第一幕 [========] 完成
第二幕 [=====>....] 进行中（60%）
第三幕 [...........] 未开始

**情节线状态**

**主线：[主线名称]** — [状态]
- 最新进展：[一句话概括]（第 [N] 章）
- 下一步行动：[从 creative-plan.md 提取]

**副线 A：[副线名称]** — [状态]
- 最新进展：[一句话概括]（第 [N] 章）

**副线 B：[副线名称]** — [状态]
- 最新进展：[一句话概括]（第 [N] 章）

**已完成情节线**：
- ✅ [情节线名称]（第 [X]-[Y] 章）
```

**进度计算方法**：

```
从 plot-tracker.json 的 plotlines 中：
  主线进度 = completedNodes.length / (completedNodes.length + upcomingNodes.length)
  副线进度 = 同上

从 specification.md 的章节规划中：
  总体进度 = 已写章节数 / 预计总章节数
```

---

### 第 3 部分：未解决的伏笔与悬念

**数据来源**：`plot-tracker.json` 的 `foreshadowing` 数组

```markdown
### 3. 未解决的伏笔与悬念 🔍

**高优先级（需尽快处理）**

⏰ **[伏笔内容描述]**
- 埋下：第 [N] 章
- 已经过：[X] 章 ⚠️ 超过 15 章未处理
- 计划解决：第 [M] 章
- 处理建议：[基于创作计划给出的建议]

**中优先级（正常节奏）**

⏳ **[伏笔内容描述]**
- 埋下：第 [N] 章
- 已经过：[X] 章
- 计划解决：第 [M] 章

**低优先级（长线伏笔）**

📌 **[伏笔内容描述]**
- 埋下：第 [N] 章
- 已经过：[X] 章
- 计划解决：第 [M] 章（长期伏笔）
```

**伏笔优先级判断算法**：

```
对于 plot-tracker.json 中每个 status == "active" 的伏笔：

  chapters_since = 当前章节 - planted.chapter
  planned_resolve = plannedReveal.chapter

  判断优先级：
  1. 如果 chapters_since > 15：
     → 高优先级（超期未处理）

  2. 如果 planned_resolve 存在 且 planned_resolve - 当前章节 <= 3：
     → 高优先级（即将需要解决）

  3. 如果 chapters_since > 8：
     → 中优先级

  4. 其他：
     → 低优先级
```

**高优先级伏笔的处理建议**：

```
如果 chapters_since > 15 且 planned_resolve 已过期：
  → "此伏笔已严重超期，建议在接下来 3 章内处理或明确推迟"

如果 chapters_since > 15 且 planned_resolve 未过期：
  → "此伏笔时间较长，建议在近期章节中埋入暗示保持读者兴趣"

如果 planned_resolve - 当前章节 <= 3：
  → "此伏笔即将到达计划解决点，请在第 [M] 章前做好铺垫"
```

---

### 第 4 部分：角色关系网络

**数据来源**：`relationships.json`

```markdown
### 4. 角色关系网络 💞

**核心关系状态**

[角色A] ←→ [角色B]：[关系类型]（[趋势符号] [趋势描述]）
  最近互动：第 [N] 章，[互动内容]

[角色A] ←→ [角色C]：[关系类型]（[趋势符号] [趋势描述]）
  最近互动：第 [N] 章，[互动内容]
  ⚠️ [如有警告，在此展示]

**关系变化趋势**（最近 5 章）
- ↗ [角色A] & [角色B]：[变化描述]
- ↘ [角色C] & [角色D]：[变化描述]
- → 其他关系保持稳定

**派系/阵营概览**（如适用）
- [派系名]：[成员]，[目标]，[状态]
```

**趋势符号说明**：

```
↗ = 关系升温/改善（trajectory: "positive"）
↘ = 关系恶化/降温（trajectory: "negative"）
→ = 关系稳定（trajectory: "stable"）
↕ = 关系不稳定/波动（trajectory: "volatile"）
```

**关系变化趋势提取**：

```
从 relationships.json 的 history 数组中：
  取最近 5 章的 changes 记录
  按 impact 排序（high > medium > low）
  展示 impact 为 high 或 medium 的变化
```

---

### 第 5 部分：上一章回顾

**数据来源**：最近章节文件（`stories/[current]/content/chapter-XX.md`）

```markdown
### 5. 上一章回顾 📄

**第 [N] 章：[章节标题]**（[字数] 字）

**核心事件**：
- [事件 1]
- [事件 2]
- [事件 3]

**章节结尾**（续写衔接点）：
> [引用上一章最后 2-3 段原文]

**结尾状态**：
- 悬念：[有/无，如果有则描述]
- 时间点：[故事内时间]
- 地点：[角色所在位置]

**下一章衔接建议**：
- [根据 tasks.md 和 creative-plan.md 提取的下一章任务]
- [续写应注意的衔接要点]
```

**上一章提取逻辑**：

```
1. 列出 stories/[current]/content/ 下所有 chapter-*.md 文件
2. 按文件名排序，取最后一个
3. 读取文件内容
4. 提取标题（第一个 # 标题）
5. 统计字数（使用 wc 或字符串计数）
6. 提取最后 2-3 段作为"章节结尾"
7. 分析核心事件（从内容中概括 3-5 个关键情节点）
```

---

### 第 6 部分：时间线快照

**数据来源**：`timeline.json`

```markdown
### 6. 时间线快照 ⏰

**故事内时间**：
- 起始时间：[年月日/第 1 天]
- 当前时间：[年月日/第 N 天]
- 已过时长：[X 天/月/年]

**重要时间节点**（倒序，最近 5 个）：
- 第 [N] 章：[事件]（[故事内日期/天数]）
- 第 [N-1] 章：[事件]（[故事内日期/天数]）
- ...

**⚠️ 时间线问题**（如有）：
- [从 timeline.json 或 plot-tracker.json 的 notes.inconsistencies 检测的问题]
```

**时间线提取逻辑**：

```
从 timeline.json 的 events 数组中：
  按 day（或 chapter）倒序排列
  取最近 5 个事件
  标记有时间矛盾的事件（如果 day 值出现非递增情况）
```

---

### 第 7 部分：创作状态检查

**数据来源**：`tasks.md` + `creative-plan.md` + 章节文件统计

```markdown
### 7. 创作状态检查 ✅

**完成度**：
- 已写章节：[N] / 预计 [M] 章（[X]%）
- 已写字数：[N] 字
- 剩余字数预估：约 [K] 字

**节奏检查**（最近 5 章）：

从 plot-tracker.json 的 currentState 或最近章节内容分析：
章节    事件密度
[N-4]   ████░░░░░░ [描述]
[N-3]   ███████░░░ [描述]
[N-2]   █████░░░░░ [描述]
[N-1]   ████████░░ [描述]
[N]     ████░░░░░░ [描述]

节奏评估：[有起伏/过于平淡/过于紧张]

**任务清单状态**（从 tasks.md 统计）：
- ✅ 已完成：[N] 项
- 🔄 进行中：[M] 项
- ⏸️ 待办：[K] 项

**下一步关键任务**（Top 3）：
1. [任务 1]（来自 tasks.md 中第一个未完成任务）
2. [任务 2]
3. [任务 3]
```

**节奏评估算法**：

```
从最近 5 章内容中分析：
  事件密度 = 章节中的关键情节点数量

评估标准：
  如果最近 5 章事件密度变化 < 2（方差很小）：
    → "过于平淡，建议增加起伏"

  如果最近 5 章事件密度持续 > 7：
    → "过于紧张，建议适当放缓让读者喘息"

  如果最近 5 章事件密度有高有低（方差 > 3）：
    → "节奏良好，有张有弛"
```

---

### 第 8 部分：快速参考卡片

**这是 `--brief` 模式下唯一输出的内容**。

```markdown
### 8. 快速参考卡片 🎯

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 **当前位置**
[主角在哪，什么状态，什么时间点]

🎯 **下一章目标**
[从 tasks.md + creative-plan.md 提取]

⚠️ **注意事项**
- [超期伏笔提醒]
- [长期未出场角色提醒]
- [一致性警告]

💡 **续写衔接**
- 上章结尾：[一句话概括]
- 衔接方式：[建议的开头方向]

🔮 **下一章注意**
- [最紧急的 1-2 个伏笔提醒，如有]
- [需出场角色提醒，如有]
- [节奏建议：一句话]

📊 **进度**：第 [N]/[M] 章（[X]%）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 第 9 部分：下一章预测性提示

**数据来源**：综合 `plot-tracker.json`、`character-state.json`、`relationships.json`、`timeline.json`、`creative-plan.md`、`tasks.md`

```markdown
### 9. 下一章预测性提示 🔮

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

#### ⏰ 即将到期伏笔
[从 plot-tracker.json 中筛选 urgency > 0.7 的伏笔]

| 伏笔 | 埋设章节 | 已过章数 | 紧急度 | 建议 |
|------|---------|---------|--------|------|
| [伏笔描述] | 第 N 章 | M 章 | 🔴 紧急 | [推进/回收/提及] |
| [伏笔描述] | 第 N 章 | M 章 | ⚠️ 较高 | [推进/回收/提及] |

**计算规则**：
- 紧急度 = 已过章数 / 类型阈值（悬疑类 5-8 章，情节类 10-15 章，世界观类 20-30 章）
- 🔴 紧急（> 0.8）：必须在下一章有所推进
- ⚠️ 较高（0.5-0.8）：建议在近 2-3 章内推进
- 如无紧急伏笔，显示「✅ 当前无紧急伏笔」

#### 👤 需关注角色
[从 character-state.json 中筛选长期未出场或状态需跟进的角色]

| 角色 | 上次出场 | 未出场章数 | 当前状态 | 建议 |
|------|---------|-----------|---------|------|
| [角色名] | 第 N 章 | M 章 | [状态] | [出场/提及/暂不需要] |

**筛选规则**：
- 主要角色超过 3 章未出场 → 建议出场或提及
- 次要角色超过 8 章未出场 → 提醒（非强制）
- 角色处于关键状态变化中（受伤、失踪、冲突中）→ 必须跟进

#### 📈 情绪曲线建议
[基于 creative-plan.md 的情绪曲线设计和最近 3 章的实际节奏]

- **最近 3 章节奏**：[高/中/低] → [高/中/低] → [高/中/低]
- **建议下一章节奏**：[基于张弛有度原则的建议]
- **理由**：[例如：连续 2 章高强度冲突后，建议适当放缓，安排过渡或角色互动]

#### 🎯 计划执行检查
[对比 creative-plan.md / tasks.md 的规划与实际进度]

- **当前进度**：第 [N] 章 / 计划第 [M] 章的内容
- **偏离检测**：[无偏离 / 轻微偏离 / 显著偏离]
- **偏离说明**：[如有偏离，说明偏离内容和建议]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**生成逻辑**：

1. **即将到期伏笔**：
   - 读取 `plot-tracker.json` 中所有 `status: "open"` 的伏笔
   - 计算每个伏笔的紧急度：`(当前章节 - 埋设章节) / 类型阈值`
   - 按紧急度降序排列，取 top 5
   - 如果没有 `plot-tracker.json`，显示「⚠️ 未找到情节追踪数据，建议执行 /track 初始化」

2. **需关注角色**：
   - 读取 `character-state.json` 中所有角色的 `lastAppearance` 字段
   - 计算未出场章数：`当前章节 - lastAppearance`
   - 筛选超过阈值的角色（主要角色 3 章，次要角色 8 章）
   - 如果没有 `character-state.json`，显示「⚠️ 未找到角色状态数据」

3. **情绪曲线建议**：
   - 读取最近 3 章的内容，判断每章的整体节奏（高/中/低）
   - 基于「高-低-高」张弛有度原则，建议下一章节奏
   - 如果最近章节不足 3 章，基于已有章节分析

4. **计划执行检查**：
   - 对比 `tasks.md` 中当前任务的描述与实际已写内容
   - 检测是否有显著偏离（新增未计划角色、跳过计划事件等）

---

## 简报尾部

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 上下文简报结束
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**建议行动**：
1. 如果有 ⚠️ 警告，先处理警告项
2. 如果有 🔴 紧急伏笔，确认下一章如何推进
3. 重读上一章结尾，找到续写衔接点
4. 确认下一章任务
5. 执行 /write 开始创作（灵感充足时可用 /write --fast）

**数据更新提醒**：
- 本简报基于当前追踪数据生成
- 如追踪数据过时，请先执行 /track 更新
- 建议每 5-10 章或隔天续写时执行一次 /recap
```

---

## 与其他命令的关系

| 命令 | 关系 | 数据流 |
|------|------|--------|
| `/track-init` | 前置基础 | 初始化追踪系统 → 为 /recap 提供数据 |
| `/track` | 数据更新 | /track 更新追踪数据 → /recap 读取最新数据 |
| `/write` | 后续流程 | /recap 重建上下文 → /write 执行写作 |
| `/analyze` | 互补验证 | /analyze 深度分析 ↔ /recap 状态概览 |
| pre-write-checklist | 集成 | /recap 简报可替代部分检查清单功能 |

**推荐工作流**：

```
隔天续写：/recap → /write
定期整理：/track → /recap → 根据简报调整计划
长篇诊断：/recap → 发现问题 → /analyze 深入分析
```

---

## 高级功能

### --brief 简化模式

```
/recap --brief
```

仅输出第 8 部分"快速参考卡片"，适合快速刷新记忆。

**使用场景**：
- 短暂离开后回来继续写
- 已经很了解故事，只需快速确认

---

## 错误处理

### 故事不存在

```
❌ 未找到活跃故事

请先执行 /specify 创建故事规格。
```

### 无章节内容

```
⚠️ 尚未开始写作

未找到任何章节文件（stories/[current]/content/）。
无法生成上下文简报。

请先执行 /write 开始创作，然后再使用 /recap。
```

### 追踪数据过期

```
⚠️ 追踪数据可能过时

最后更新时间：[日期]（[N] 天前）
已写章节数超过最后更新时的章节数 [X] 章。

建议先执行 /track 更新追踪数据后再查看简报。
```

---

## 技术说明

### 数据处理优先级

当多个数据源存在冲突时：
1. **追踪文件** > **章节内容推断**（追踪文件经过 /track 验证，更可靠）
2. **最近章节** > **早期章节**（最近的信息更准确）
3. **character-state.json** > **规格文件**（实时状态 > 初始设定）

### 信息量控制

- **主要角色**：展示完整信息（位置、状态、目标、弧线）
- **次要角色**：一句话状态
- **伏笔**：按优先级排序，高优先级详细展示，低优先级简要列出
- **关系**：仅展示有变化或有问题的关系

### 简报长度参考

- **完整简报**（8 部分）：约 800-1500 字
- **简化简报**（--brief）：约 200-300 字

---

## 成功标准

**用户反馈目标**：
- "5 分钟就能想起所有关键信息"
- "不再害怕隔天续写"
- "30 章后依然清楚知道故事在哪"

**技术指标**：
- 信息准确率 > 95%（基于追踪数据的准确性）
- 警告召回率 > 90%（真实问题能被检测到）
- 简报覆盖度 100%（所有有效追踪数据都被纳入简报）

---

## 🔗 命令链式提示

**命令执行完成后，自动附加下一步建议**：

```
💡 下一步建议：
1️⃣ `/write [下一章节号]` — 上下文已重建，开始续写
2️⃣ `/track --check` — 如简报中有警告，先检查数据一致性
3️⃣ `/analyze` — 如发现多个问题，执行全面质量分析
```
