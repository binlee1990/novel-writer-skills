---
name: story-facts-checker
description: "Use during and after chapter writing to verify that quantifiable facts (numbers, names, settings) match the single source of truth in story-facts.json - alerts when detecting inconsistencies"
allowed-tools: Read, Grep
---

# Story Facts 校验器

## 职责范围

本 skill 负责校验故事中**可量化的设定事实**（数字、名称、枚举值）与单一数据源 `spec/tracking/story-facts.json` 的一致性。

### 与 consistency-checker 的分工

| Skill | 负责内容 | 示例 |
|-------|---------|------|
| **consistency-checker** | 定性的角色行为、世界规则、时间线逻辑 | 角色性格是否一致、魔法系统是否矛盾、事件顺序是否合理 |
| **facts-checker** | 定量的设定事实、数值逻辑 | 宗门月亏损是否一直是 1000 灵石、宗门名称是否统一、算术关系是否成立 |

**两者互不替代**：consistency-checker 关注"行为逻辑"，facts-checker 关注"数据准确性"。

---

## 自动校验流程

### 触发时机

- `/write` 命令的**质量自检阶段**（自动调用）
- `/facts check` 命令（手动触发）
- 用户明确要求校验当前章节的 facts

### V1 校验范围：声明引用校验

当前版本仅校验**在章节头部显式声明**的事实引用。

#### 执行步骤

1. **读取章节注释头**
   - 查找 `<!-- story-facts: ... -->` 注释
   - 提取声明的 fact ID 列表
   - 如果未找到注释，跳过校验（不报错）

2. **加载事实数据源**
   - 读取 `spec/tracking/story-facts.json`
   - 提取声明的 fact ID 对应的当前值

3. **扫描正文内容**
   - 对每个声明的 fact，在正文中查找其值的出现
   - 检查数值和单位是否与数据源一致
   - 对于字符串类型（如名称），检查是否精确匹配

4. **验证算术规则**
   - 遍历 `story-facts.json` 中的 `rules` 数组
   - 筛选出涉及本章声明的 facts 的规则
   - 验证算术表达式是否成立

5. **输出校验结果**

---

## 校验报告格式

### 成功案例（无问题）

```
✅ Story Facts 校验通过

本章声明的事实 (3 个):
  ✓ finance-monthly-deficit = 1000灵石
  ✓ finance-reserve = 5000灵石
  ✓ sect-outer-disciples = 200

算术规则 (1 个):
  ✓ rule-deficit: 1500 - 500 == 1000 ✅ 成立
```

### 检测到不一致

```
⚠️ Story Facts 校验警告

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 数值不一致
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ finance-monthly-deficit
  数据源: 1000灵石
  正文: "宗门月亏损达到一千五百灵石"
  位置: 第4章.md，第12段

建议：
  1. 如果数据源正确，修改正文为 "一千灵石"
  2. 如果剧情发展导致数值变化，使用 /facts update 更新数据源

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 算术规则失败
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ rule-deficit
  表达式: finance-monthly-expense - finance-monthly-income == finance-monthly-deficit
  计算: 1500 - 500 == 1500 (实际 1000)

建议：
  检查 finance-monthly-deficit 的值是否正确，或使用 /facts update 同步更新
```

### 未声明引用（提示性）

```
💡 Story Facts 提示

检测到正文中可能的新事实（未注册）:
  - "外门弟子共有二百人" → 考虑注册为 sect-outer-disciples (number)
  - "青云宗" → 考虑注册为 sect-name (string)

使用 /facts 添加这些事实以便后续追踪。
```

---

## 校验限制（V1）

### 当前支持

- ✅ 精确字符串匹配（数字 + 单位）
- ✅ 算术规则验证（加减乘除、比较）
- ✅ 字符串精确匹配（如宗门名称）
- ✅ 枚举值检查

### 当前不支持（后续版本）

- ❌ 中文数字识别（"五百" ≠ 500）
- ❌ 近义表达匹配（"灵石储备" vs "库存灵石"）
- ❌ 语义约束（如 "下三品宗门弟子不超过 200"）
- ❌ date 类型和时间线自动推算

### 误报处理

**场景**：正文写 "五百灵石"，数据源是 500，工具报告不一致。

**原因**：V1 仅支持精确匹配，无法识别中文数字。

**解决**：
1. **短期**：建议作者统一使用阿拉伯数字（"500 灵石"）
2. **长期**：等待 V2 支持中文数字模糊匹配

---

## 使用示例

### 场景 1: 写作新章节

```markdown
# 第10章 财务困局

<!-- story-facts: finance-monthly-deficit, finance-reserve, finance-runway -->

第十天，陆衡在执事堂查看账本。
宗门月亏损一千灵石，而库存仅剩五千灵石，
按此速度，最多还能撑五个月。
```

**自动校验结果**：

```
✅ Story Facts 校验通过

本章声明的事实 (3 个):
  ✓ finance-monthly-deficit = 1000灵石
  ✓ finance-reserve = 5000灵石
  ✓ finance-runway = 5月

算术规则:
  ✓ finance-reserve / finance-monthly-deficit == finance-runway
    计算: 5000 / 1000 == 5 ✅
```

### 场景 2: 检测到矛盾

```markdown
# 第15章 意外收入

<!-- story-facts: finance-monthly-deficit -->

经过三个月的努力，陆衡将宗门月亏损从一千五百灵石降到了五百灵石。
```

**校验结果**：

```
⚠️ Story Facts 校验警告

❌ finance-monthly-deficit
  数据源: 1000灵石
  正文出现: "一千五百灵石" 和 "五百灵石"

疑似问题：
  1. 正文描述的是变化过程（从 1500 降到 500）
  2. 但数据源当前值是 1000

建议：
  - 如果 1000 是第15章前的值，正文描述的 "一千五百" 可能有误
  - 如果剧情中确实发生了变化，考虑：
    a) 更新数据源为新值 500
    b) 或添加新的 fact ID: finance-monthly-deficit-ch15
```

### 场景 3: 新事实提示

写作完成后，系统检测到未注册的可量化事实：

```
💡 Story Facts 提示

检测到以下可能的新事实（正文中有明确数值但未注册）:

1. "外门弟子二百人"
   建议 ID: sect-outer-disciples
   类型: number
   值: 200
   单位: 人

2. "内门长老十二位"
   建议 ID: sect-inner-elders
   类型: number
   值: 12
   单位: 位

使用 /facts 命令添加这些事实以便后续追踪。
```

---

## 新事实检测逻辑

### 触发条件

在 `/write` 命令的**后置处理阶段**，写作完成后自动执行。

### 检测规则

扫描正文，查找符合以下模式的文本：

1. **数字 + 单位** 组合：
   - 正则：`(\d+)(灵石|人|位|月|年|里|丈|尺|枚|颗|株)`
   - 示例：`1000灵石`、`200人`、`5月`

2. **中文数字 + 单位** 组合（识别但提示用户确认）：
   - 正则：`(一|二|三|...|十|百|千)(灵石|人|...)`
   - 示例：`五百灵石`、`十二位长老`

3. **专有名词** 首次出现（首字母大写或引号包围）：
   - 示例：`"青云宗"`、`《青云心法》`

### 去重逻辑

- 检查 `story-facts.json` 中是否已存在相同值的 fact
- 检查之前章节的 `<!-- story-facts: ... -->` 注释中是否已声明

### 输出格式

仅**提示**，不自动注册。用户需手动使用 `/facts` 命令添加。

---

## 与 /write 命令的集成

### 集成点 1: 资源加载阶段

**时机**：开始写作前

**操作**：
1. 读取当前章节是否已有 `<!-- story-facts: ... -->` 注释
2. 如果有，从 `story-facts.json` 加载这些 fact 的当前值
3. 展示给作者作为写作参考

**输出格式**：

```
📋 本章引用的设定事实（来自 story-facts.json）:

  - finance-monthly-deficit: 宗门月亏损 = 1000灵石
  - finance-reserve: 灵石储备 = 5000灵石
  - finance-runway: 储备可撑月数 = 5月

⚠️ 写作时请确保上述数值与正文一致。
```

### 集成点 2: 质量自检阶段

**时机**：章节写作完成，进入自检流程

**操作**：
1. 自动调用 facts-checker skill
2. 执行上述"自动校验流程"
3. 输出校验报告

**处理策略**：
- **不阻断写作流程**：即使检测到不一致，也允许写作完成
- 输出警告，提示用户后续修复

### 集成点 3: 后置处理阶段

**时机**：所有质量检查完成后

**操作**：
1. 执行新事实检测
2. 如果检测到未注册的可量化事实，输出提示
3. 询问用户是否需要注册

---

## 最佳实践

### 作者角度

1. **写作前查看引用的事实**：
   - 如果章节已有 `<!-- story-facts: ... -->` 注释，开始写作时会自动展示
   - 将这些数值作为写作时的快速参考

2. **写作完成后检查报告**：
   - 如果 facts-checker 报告不一致，优先相信数据源
   - 如果剧情确实发生变化，使用 `/facts update` 更新

3. **及时注册新事实**：
   - 看到"新事实提示"时，评估是否需要追踪
   - 关键数值（如经济、人员、时间）应立即注册

### 技术角度

1. **章节注释是声明性的**：
   - 注释头只是"声明"本章引用了哪些事实
   - 实际值永远以 `story-facts.json` 为准

2. **正文是校验目标**：
   - facts-checker 检查正文中的值是否与数据源一致
   - 不检查未声明的事实（避免误报）

3. **算术规则是保护网**：
   - 如果数值之间有数学关系，应在 `rules` 中声明
   - 校验时自动验证这些关系是否成立

---

## 调试和问题排查

### 常见问题

#### 1. "章节未声明任何事实，跳过校验"

**原因**：章节头部没有 `<!-- story-facts: ... -->` 注释

**解决**：
- 如果本章确实引用了已注册的事实，手动添加注释
- 如果是新章节，写作完成后会自动添加

#### 2. "无法读取 story-facts.json"

**原因**：文件不存在或路径错误

**解决**：
- 执行 `/facts` 初始化数据源（会创建空文件）
- 确认项目是通过 `novelws init` 生成的

#### 3. "检测到不一致但我确认正文正确"

**原因**：数据源过期或初始值设置错误

**解决**：
- 使用 `/facts update <fact-id>` 更新数据源
- 或直接编辑 `story-facts.json`（不推荐，可能漏掉其他引用）

#### 4. "算术规则总是失败"

**原因**：expression 语法错误或涉及的 fact ID 不存在

**解决**：
- 检查 `story-facts.json` 中的 `rules[].expression`
- 确保使用的 fact ID 都已注册
- 验证表达式语法（如 `A - B == C`）

---

## 版本演进路线

### V1（当前）

- 声明引用校验（基于章节注释头）
- 精确字符串匹配
- 算术规则验证
- 新事实检测提示

### V2（计划中）

- 中文数字识别（"五百" = 500）
- 近义表达模糊匹配
- 自动推断引用（即使没有注释头）
- tracking 文件中的事实引用扫描

### V3（未来）

- date 类型支持
- 时间线自动推算（如 "三个月后" 自动计算日期）
- 语义约束规则（基于自然语言描述的复杂规则）
- 多故事事实共享（系列小说场景）
